<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="NUMA 架构">
  
  <meta name="description" content="个人对 NUMA 架构的一些理解。">
  <meta property="og:description" content="个人对 NUMA 架构的一些理解。">
  
  <meta property="og:type" content="blog">
  <title>NUMA 架构</title>
  <!-- Favicon -->
  
  <link rel="shortcut icon" href="https://avatars1.githubusercontent.com/u/32795735?s=400&u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&v=4">
  
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span><img class="inline-img-icon" src="https://avatars1.githubusercontent.com/u/32795735?s=400&u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&v=4"></span> <span>Home</span></div>
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>😀</span> <span>About</span></div>
    </a>
    
    
  </nav>
  <header class="Header">
      
    <div class="Header__Cover">
        <img src="https://www.linuxidc.com/upload/2018_03/18032409202878.png">
      </div>
      
    <div class="Header__Spacer ">
    </div>
    
    <div class="Header__Icon"><span><img class="inline-img-icon" src="https://gitee.com/zhxuankun/Image/raw/master/Avator/linux.png"></span></div>
    
    <h1 class="Header__Title">NUMA 架构</h1>
        
    <div class="DateTagBar">
          
      <span class="DateTagBar__Item DateTagBar__Date">Posted on Sun, Feb 21, 2021</span>
          
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/Linux.html">Linux</a>
          </span>
          
        </div>
        
  </header>
      <article id="https://www.notion.so/c52fe20cb9c84cd1bb42d02465dbe49a" class="PageRoot PageRoot--FullWidth"><ul id="https://www.notion.so/118bf6fdda0146779314f4e27a2bd441" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/75da60797530499eab5ea4bd32298961"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1. 硬件角度</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/320482a1222645dcb1e450d86ea22ee0"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. Linux 角度</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/c57a3d8cc710401f91ad9e77dcacfce6"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. 解决方案</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/b30f704349d0466fb868631fdc9dba5d"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4. 使用方式</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/93fe50c24d404684b8edbeaec85ef8a1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4.1 numactl</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/6ff8b6edcffd4002a70f3dfbad7463ec"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4.2 Yarn 方式</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3e4d88ef1d474c1bb90e4b9e55aa66c5"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4.3 JVM 方式</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/66b577190f0848e6831946fd9f7a962b"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">5. 测试效果</strong></span></span></div></a></li></ul><div id="https://www.notion.so/b2d6c1e7f90946db91bf20eedd3e9419" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">NUMA （</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://en.wikipedia.org/wiki/Non-uniform_memory_access">Non-uniform memory access</a></span><span class="SemanticString">，非一致性内存访问）架构是近代计算机常见的一种架构。随着 CPU 近年来性能提升速度的逐渐放缓，开始出现通过多个 CPU 共同工作来提升性能的方式，而 NUMA 则是伴随这种方式出现的一种优化方案。</span></span></p></div><h3 id="https://www.notion.so/75da60797530499eab5ea4bd32298961" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/75da60797530499eab5ea4bd32298961"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1. 硬件角度</strong></span></span></h3><div id="https://www.notion.so/648188d2592d43a2aca9900801d8aeb6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从硬件角度来看，如果按照以前的计算机架构，多个 CPU 之间访问同一块内存，会共用一个 bus：</span></span></p></div><div id="https://www.notion.so/ed835ef9b9884e55966b7655e4d32103" class="Image Image--Normal"><figure><a href="https://i2.wp.com/jcole.us/blog/files/uma-architecture.png?width=288"><img src="https://i2.wp.com/jcole.us/blog/files/uma-architecture.png?width=288" style="width:288px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/111f848f2c4c452898f0dc1702c65466" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但是这样一来，bus 就很可能出现性能瓶颈，导致整体性能的降低，因此就出现了 NUMA 架构：</span></span></p></div><div id="https://www.notion.so/ef4c10bd193049b3acafb789c3201a92" class="Image Image--Normal"><figure><a href="https://i2.wp.com/jcole.us/blog/files/numa-architecture.png?width=288"><img src="https://i2.wp.com/jcole.us/blog/files/numa-architecture.png?width=288" style="width:288px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/404ef86019dd40fc9d551c9645927e25" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">每个 CPU 都拥有自己的一块 “本地” 内存，其他 CPU 的内存则可以看做是 “远程” 内存。这种架构下，CPU 访问自己的本地内存会有更低的延迟以及更高的性能表现。</span></span></p></div><h3 id="https://www.notion.so/320482a1222645dcb1e450d86ea22ee0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/320482a1222645dcb1e450d86ea22ee0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. Linux 角度</strong></span></span></h3><div id="https://www.notion.so/92cd07c0a3f74842b953f52310222339" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从 Linux 角度来看，基于这种硬件结构，一个 CPU 会被抽象成一个 NUMA Node， 并且尽可能将 CPU 所需要的内存分配在它的本地内存中。</span></span></p></div><div id="https://www.notion.so/d489ea421bbd4d3a9b5b014349bffab8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但是在一个 NUMA Node 的内存即将耗尽的时候，Linux 采取的默认策略是 </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">swap/淘汰</strong></span><span class="SemanticString"> 内存页，这样对于大内存应用（比如一个应用内存大于一个 NUMA Node 的所有内存）来说，一旦某个后续需要用到那部分内存页，就会出现明显的性能下降。</span></span></p></div><h3 id="https://www.notion.so/c57a3d8cc710401f91ad9e77dcacfce6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/c57a3d8cc710401f91ad9e77dcacfce6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. 解决方案</strong></span></span></h3><div id="https://www.notion.so/366871eb24ff4784a10e210aa7d36574" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">目前有几个比较主流的方法如下：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/1723ea4900a14755a9d16e31a83a25d5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">numactl --interleave=all</code></span><span class="SemanticString"> 指定程序运行时随机分配在多个 NUMA Node 上。</span></span></li><li id="https://www.notion.so/d53368129b8c460591b44179d8ea330f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">设置 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">vm.zone_reclaim_mode=0</code></span><span class="SemanticString">，当本地内存不够时优先去远程内存分配。</span></span></li><li id="https://www.notion.so/ec79cab906154f4c90a86ed854c6f760" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">使用 numad 自动管理 NUMA 内存分配。</span></span></li></ul><div id="https://www.notion.so/5d35a9c3129e4e8987fe87048013a194" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">numactl --interleave=all</code></span><span class="SemanticString"> 咋看之下好像失去了 NUMA 的优势，但是大部分情况下，一个应用可以分为稳定的线程（系统线程）以及经常变化的线程（用户创建的线程），对于稳定的线程来说，固定在一个 NUMA Node 下可以获得最好的性能，而对于随机分配在不同 CPU 下的用户线程来说，随机分配反而可以产生奇效，借用网上的一个性能测试结果：</span></span></p></div><div id="https://www.notion.so/71c3d199e97e4694af63ef776180b601" class="Image Image--PageWidth"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210220163016.png"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210220163016.png" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/ae93a98a78af49cd89a391e832b38cb5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从上面的图可以看出，绝大部分场景下的性能表现，NUMA 默认 &lt; 手动绑定 Numa Node &lt; interleave 方式。因此，绝大部分场景下，NUMA 的性能瓶颈不在于远程内存访问，而是在于 NUMA 导致的内存页 swap/淘汰。</span></span></p></div><div id="https://www.notion.so/c2f8d275a4e04dbd94449b80c39f6060" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">numad，是属于提供 NUMA 自动内存管理的守护线程，</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index#sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-Performance_Monitoring_Tools-numad">官方</a></span><span class="SemanticString">介绍如下：</span></span></p></div><blockquote id="https://www.notion.so/938e10ecc3ea4e52a1cf7bf4bd4dd852" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">numad is an automatic NUMA affinity management daemon. It monitors NUMA topology and resource usage within a system in order to dynamically improve NUMA resource allocation and management (and therefore system performance). Depending on system workload, numad can provide up to 50 percent improvements in performance benchmarks. It also provides a pre-placement advice service that can be queried by various job management systems to provide assistance with the initial binding of CPU and memory resources for their processes.</span></span></blockquote><div id="https://www.notion.so/6193acf30e0c40cdb9ea3205b1805a69" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">numad 会周期性地地监控 NUMA 的资源使用情况，必要的时候会在 NUMA Node 之间移动进程以求达到最佳性能效果。</span></span></p></div><div id="https://www.notion.so/02e2b363f6104b43807e47cb6a19c057" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">numad 主要的受益对象有：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/2c1b6ed74f7a47cbbd61619c9078c821" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">消耗大量系统资源且长时间运行的进程</span></span></li><li id="https://www.notion.so/5cec6bb988284ba28f9d82885bfe225e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">同时消耗多个 NUMA Node 资源的进程。</span></span></li></ul><div id="https://www.notion.so/d58eeac4c5334910abba8d68b59b068a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于那些只运行数分钟，或者只消耗少量资源的进程，numad 并不能带来性能上的提升，此外，那些具有连续性、不可预测的内存访问的系统，比如大内存的数据，也无法从 numad 获得提升。</span></span></p></div><div id="https://www.notion.so/52768e14b49b40bdbfb50f23b07a0003" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于 numad 的使用，可以参照</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-red_hat_enterprise_linux-performance_tuning_guide-tool_reference-numad">官方文档</a></span><span class="SemanticString">。</span></span></p></div><h2 id="https://www.notion.so/b30f704349d0466fb868631fdc9dba5d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b30f704349d0466fb868631fdc9dba5d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4. 使用方式</strong></span></span></h2><div id="https://www.notion.so/830c9bf313b64dd08ed4601dfef01325" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们可以很简单的借助 numad 享受到 numa 机制带来的提升，但 numa 机制也不是适用于所有类型的程序，如果服务器需要运行多种类型的程序（比如只消耗少量资源，只运行短暂时间），那么 numad 往往不能为其带来太大的提升，反而可能会带来调度上的开销。</span></span></p></div><div id="https://www.notion.so/0e2b5fc75e024dbfbe000fc2be0dd927" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">针对上面这种场景，在不适用 numad 方式下，可以使用 numactl 方式指定程序运行的 numa node，同时各个软件（如 JDK、Yarn）也有对 numa 提供了一定程度上的支持。</span></span></p></div><h3 id="https://www.notion.so/93fe50c24d404684b8edbeaec85ef8a1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/93fe50c24d404684b8edbeaec85ef8a1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4.1 numactl</strong></span></span></h3><div id="https://www.notion.so/90b0b322dfb6416aa68b9585d947c215" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">numactl 可以指定进程在哪个 numa node 节点上运行，同时指定在哪个 numa node 节点上分配内存，格式如下：</span></span></p></div><pre id="https://www.notion.so/65eff93717604bbebd461555baf968fc" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span> numactl -N 0-1 -m 0-1 [命令]</span></span></span></code></pre><div id="https://www.notion.so/cdf14a87bf8849d58f91abd4cdd05621" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">numactl 的参数含义如下：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/b44bdb262b774b6c8be0b98af436a981" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">N 0-1</code></span><span class="SemanticString">：指定该进程在 0、1 号 numa node 上运行，也可以单独指定一个 numa node</span></span></li><li id="https://www.notion.so/3cd4d01ba4bd411286dac93e4635c797" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">m 0-1</code></span><span class="SemanticString">：指定该进程在 0、1 号 numa node 上分配内存，也可以单独指定一个 numa node</span></span></li></ul><div id="https://www.notion.so/4d04f8aa24a9446f9aac7def0fbcf6ee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">验证过程如下：</span></span></p></div><pre id="https://www.notion.so/52a7e14e5bbe46ff8054e07009b4ec20" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span> # 指定休眠进程在 0 号 numa node 上运行
 [root@dn22 ~]# nohup numactl -N 0 -m 0 sleep 60 &amp;
 [3] 3811
 
 # 使用 taskset 查看进程所在节点
 [root@dn22 ~]# taskset  -cp 3811
 pid 3811&#x27;s current affinity list: 0-7,16-23
 
 # 可以看到， 0-7，16-23 核心属于 0 号 numa node
 [root@dn22 ~]# numactl -H
 available: 2 nodes (0-1)
 node 0 cpus: 0 1 2 3 4 5 6 7 16 17 18 19 20 21 22 23
 node 0 size: 130946 MB
 node 0 free: 1003 MB
 node 1 cpus: 8 9 10 11 12 13 14 15 24 25 26 27 28 29 30 31
 node 1 size: 131072 MB
 node 1 free: 1234 MB
 node distances:
 node   0   1
   0:  10  21
   1:  21  10</span></span></span></code></pre><h3 id="https://www.notion.so/6ff8b6edcffd4002a70f3dfbad7463ec" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/6ff8b6edcffd4002a70f3dfbad7463ec"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4.2 Yarn 方式</strong></span></span></h3><div id="https://www.notion.so/e353fa8eceb24754b2aeb153313f1921" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Yarn 从 3.1.0 版本开始支持 numa 调度，开启方式如下：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/7e1ba3e8c7bd4519ae08c0ee9d82fca0" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">设置 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">yarn.nodemanager.numa-awareness.enabled</code></span><span class="SemanticString"> 为 true</span></span></li><li id="https://www.notion.so/c565f11de8874263b32f7d124785dc2b" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">对 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">yarn.nodemanager.numa-awareness.read-topology</code></span><span class="SemanticString"> 进行设置，分两种情况：</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/7e5cdf6c753b467495bb31a7e693d53f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">true</strong></span><span class="SemanticString">：Yarn 会自动通过 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">numactl --hardware</code></span><span class="SemanticString"> 命令获取机器上的 numa 拓扑结构信息</span></span></li><li id="https://www.notion.so/c029e848fa85431585ca4de978e66b7d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">false</strong></span><span class="SemanticString">：Yarn 不会自动获取 numa 拓扑结构信息，而是依赖于以下配置获取 numa 拓扑结构信息：</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/446ff42af9964a3fbf8fe33c8a0ab9c0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">yarn.nodemanager.numa-awareness.node-ids</strong></span><span class="SemanticString">：指定可用的 numa 节点，即 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">NODE_ID</code></span><span class="SemanticString">，多个 numa 节点使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">,</code></span><span class="SemanticString"> 分隔符隔开，如 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">0,1,2</code></span></span></li><li id="https://www.notion.so/34d067b57d1e4a3ab9e15b964b1d1bab" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">yarn.nodemanager.numa-awareness.&lt;NODE_ID&gt;.memory</strong></span><span class="SemanticString">：指定各个 numa 节点可用的内存，多个 numa 节点则根据其 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">NODE_ID</code></span><span class="SemanticString"> 配置多项</span></span></li><li id="https://www.notion.so/e29658d7f73b4971a743836b7c16c824" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">yarn.nodemanager.numa-awareness.&lt;NODE_ID&gt;.cpus</strong></span><span class="SemanticString">：指定各个 numa 节点可用的 cpu 核数，多个 numa 节点则根据其 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">NODE_ID</code></span><span class="SemanticString"> 配置多项</span></span></li></ul></li></ul></li></ol><div id="https://www.notion.so/f3b2b24ab1864f61933d467890f8a585" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为了支持该特性，节点上还需要预先安装 numactl 工具。</span></span></p></div><h3 id="https://www.notion.so/3e4d88ef1d474c1bb90e4b9e55aa66c5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/3e4d88ef1d474c1bb90e4b9e55aa66c5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4.3 JVM 方式</strong></span></span></h3><div id="https://www.notion.so/750f4ec05b5c4b8db0a8a60511ec2195" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">JVM 也提供了对 NUMA 的支持，但对 GC 算法以及 JDK 版本有要求：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/6e860942910a4a0887a07e018f667356" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">ParallelGC 支持 NUMA（JDK 6）</span></span></li><li id="https://www.notion.so/9e4efea943ad4d8598e9a64010feb817" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">ZGC 支持 NUMA（JDK 11）</span></span></li><li id="https://www.notion.so/689a43d8614a492b8e4a6b74e7479e3f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">G1 GC 在 JDK 14 开始支持 NUMA</span></span></li></ul><div id="https://www.notion.so/d09c86206bbc482dba782bdf5c8d517e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在 JVM 启动参数上添加 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">-XX:+UseNUMA</code></span><span class="SemanticString"> 开启 NUMA 感知，这里简述下 ParallelGC 是如何利用 NUMA 的：</span></span></p></div><div id="https://www.notion.so/5546ffc639de42428051671fbdbcf2fc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">JVM 实现了 NUMA 感知分配内存的 allocator，该 allocator 基于一个假说：对于一个对象来说，创建该对象的线程是最有可能会使用该对象的线程。因此该 allocator 主要针对频繁生成新对象的 eden 区域，优先在线程所在的 numa node 上分配对象，以保证该线程后续能以最快的速度去访问对象，其他区域的内存部分则是通过交织的方式，在各个 numa node 上均衡分配。</span></span></p></div><div id="https://www.notion.so/a4d9b4b50f4741fb8c0c863d3c96b535" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">其余 GC 算法的 numa 感知实现机制可以自行查阅资料。</span></span></p></div><h2 id="https://www.notion.so/66b577190f0848e6831946fd9f7a962b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/66b577190f0848e6831946fd9f7a962b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">5. 测试效果</strong></span></span></h2><div id="https://www.notion.so/769ab9f638594f59b1b8f2960a55a9f1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">目前有看到比较好的测试案例：</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://indico.cern.ch/event/304944/contributions/1672535/attachments/578723/796898/numa.pdf">https://indico.cern.ch/event/304944/contributions/1672535/attachments/578723/796898/numa.pdf</a></span><span class="SemanticString"> 。</span></span></p></div><div id="https://www.notion.so/5f970894741f4eb0b49e54cb9fa36221" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在自己集群测试中，运行一个 Spark 流式作业，开启 numad 前后对比如下：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/2d5e292f3fe64aabb873504967d9b584" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">开启前：1853.0 h (123.0 h)，GC 占比： 123 / 1853 ~= 5.47%</span></span></li><li id="https://www.notion.so/3ce78613f1c74cdfa9a704c7d2bc2c53" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">开启后： 2792.5 h (139.3 h)，GC 占比：139.3 / 2792.5 ~= 4.99%</span></span></li></ul><div id="https://www.notion.so/e4820c4e09ff4e87aad3b051cfe34874" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">集群 CPU 整体利用率变化如下：</span></span></p></div><div id="https://www.notion.so/b93ca765fc8c4278915ddee91e35f492" class="Image Image--PageWidth"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/blog/image.png"><img src="https://gitee.com/zhxuankun/Image/raw/master/blog/image.png" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/2680c2c86fd147ae87074504fe745877" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从中可以看出， CPU 峰值 43% 下降到了 37%，CPU 负载也有一定的减轻。</span></span></p></div><div id="https://www.notion.so/ac68a2e3734e45d0b38ec23d7ae45879" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">参考：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/0919d7e27cb54eaf93119c27c0ab46d4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="http://cenalulu.github.io/linux/numa/">NUMA架构的CPU -- 你真的用好了么？</a></span></span></li><li id="https://www.notion.so/892cec0d700d428e916d5292fb7d7924" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://blog.jcole.us/2010/09/28/mysql-swap-insanity-and-the-numa-architecture/">The MySQL “swap insanity” problem and the effects of the NUMA architecture</a></span></span></li><li id="https://www.notion.so/cc0110b93d53474a850761e4f971bd84" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://issues.apache.org/jira/browse/YARN-5764">NUMA awareness support for launching containers</a></span></span></li><li id="https://www.notion.so/24bbd0d1dd7e4501a147e0120cd4c5f0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.oracle.com/javase/7/docs/technotes/guides/vm/performance-enhancements-7.html">Java HotSpot™ Virtual Machine Performance Enhancements</a></span></span></li></ul></article>
  <footer class="Footer">
        <div>&copy; Rianico‘s Blog 2019</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>