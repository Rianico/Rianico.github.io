<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://avatars1.githubusercontent.com/u/32795735?s=400&amp;u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&amp;v=4">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Yarn Lable 实践&nbsp;|&nbsp;Rianico‘s Blog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Yarn Lable 实践">
  
    <meta name="description" content="关于 Yarn Label 的一次调研">
    <meta property="og:description" content="关于 Yarn Label 的一次调研">
  
  
    <meta property="og:image" content="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4af1b0a0-aacb-42b1-8102-7e87210bd3d0%2Felephant.png?table=block&amp;id=6574a8d6-cb8a-411b-a1fa-b266453fa887">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://avatars1.githubusercontent.com/u/32795735?s=400&amp;u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&amp;v=4"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F88bfa795-fb50-42ad-b5f9-821f35ee821d%2Fgithub_(2).png?table=block&amp;id=457ca390-7a74-4a2f-9c26-1613b0d49d9c"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
</nav>
  <header class="Header">
    
      <div class="Header__Cover">
        <img src="https://www.notion.so/images/page-cover/gradients_11.jpg">
      </div>
    
    <div class="Header__Spacer ">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4af1b0a0-aacb-42b1-8102-7e87210bd3d0%2Felephant.png?table=block&amp;id=6574a8d6-cb8a-411b-a1fa-b266453fa887"></span>
      </div>
    
    <h1 class="Header__Title">Yarn Lable 实践</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sun, Nov 28, 2021</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--yellow">
            <a href="tag/Hadoop.html">Hadoop</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--yellow">
            <a href="tag/Yarn.html">Yarn</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/6574a8d6cb8a411ba1fab266453fa887" class="PageRoot PageRoot--FullWidth"><ul id="https://www.notion.so/6906046a7fd547c38e694912a514c381" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/6948be8a6d8641f58eb07e8dd78e8764"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1. 开启 Yarn Lables 相关功能</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9dc02ba86f2842b499226a00488fbf94"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. 添加 Node Labels</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/fe4de26ed9e64b0cb7b214fcd7c48b43"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. 节点分配 Label</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/8c8a6047deea427885956cf8a704d86c"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. 队列绑定 Label</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/23e95c440ab346afb1b3417380d6d2c9"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4. 测试</strong></span></span></div></a></li></ul><div id="https://www.notion.so/96a6c021fee44fcabf1d15a25d6a02a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Yarn Label 可以基于节点标签的信息，对任务的分布进行细粒度控制。该特性从 Hadoop 2.6  版本开始引入，到了 Hadoop 2.8 开始才较为成熟，可以根据节点的一些角色定位、处理能力（结合具体业务场景）等按需对节点划分为几个不同的区域（分组），并可以让作业在指定分区下的节点上运行。</span></span></p></div><div id="https://www.notion.so/0dc3e26e9b874f57b1a6d0f5ba72c584" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当前 Yarn Label 只能基于 Capacity 调度方式进行工作，暂不支持其他调度方式。</span></span></p></div><div id="https://www.notion.so/91f822f5d4c54b72a5ef4a4c6dbe0023" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Yarn Label 需要结合节点、用户队列使用，三者结构如下：</span></span></p></div><div id="https://www.notion.so/594943989f384b60b3d0bb08d620385a" class="Image Image--Normal"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210311091541.png?width=576"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210311091541.png?width=576" style="width:576px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/34e1b1f8fd174b11a0894770c90eac77" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一个 Label 下可以有多个 Node，一个 Lable 可以被多个  Queue 共享，一个 Queue 可以有多个 Lable。</span></span></p></div><h2 id="https://www.notion.so/6948be8a6d8641f58eb07e8dd78e8764" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6948be8a6d8641f58eb07e8dd78e8764"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1. 开启 Yarn Lables 相关功能</strong></span></span></h2><div id="https://www.notion.so/da93460d0cc34de0a251e10a6b5f1d42" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">环境信息如下：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/497e98d70f12471295f6c272e80e3fb6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Ambari 2.7.3</span></span></li><li id="https://www.notion.so/565885abb9d9402fac345a28165222aa" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">HDP 3.1.0</span></span></li><li id="https://www.notion.so/9635f3424c5f4b819c05eee48d51b6b3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">鲲鹏服务器（arm）：agent1</span></span></li><li id="https://www.notion.so/b1da7f73a7934864bef578b3f690acd5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">戴尔服务器（x86）：agent2</span></span></li></ul><div id="https://www.notion.so/bf1d60c783874e6095b2e8bb2101f38a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首先开启 Yarn 服务下的 Node Labels 功能（等同于修改 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">yarn-site.xml</code></span><span class="SemanticString"> 的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">yarn.node-labels.enabled</code></span><span class="SemanticString"> 为 true）：</span></span></p></div><div id="https://www.notion.so/4eac90bc6b3b4eeca00a91047e3588a0" class="Image Image--Normal"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210223155451.png?width=816"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210223155451.png?width=816" style="width:816px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e60f936945234a2ca8feb5489c6a916d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在 HDFS 上创建一个存储 Node Lables 信息的路径：</span></span></p></div><pre id="https://www.notion.so/ab11ac09b9ac44c283b18c83ea0e38ad" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>sudo su hdfs
hadoop fs -mkdir -p /yarn/node-labels
hadoop fs -chown -R yarn:yarn /yarn
hadoop fs -chmod -R 700 /yarn</span></span></span></code></pre><div id="https://www.notion.so/ef8f16b84ae14758b517d709b8cc43fd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">创建 yarn 用户目录：</span></span></p></div><pre id="https://www.notion.so/3cd8328eb0d940dc8e5c11c3fa69e0b7" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>hadoop fs -mkdir -p /user/yarn
hadoop fs -chown -R yarn:yarn /user/yarn
hadoop fs -chmod -R 700 /user/yarn</span></span></span></code></pre><div id="https://www.notion.so/9cd5b82a6a9248b38523a4a8ba5abbff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">修改 Yarn 服务的 </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">YARN Node Labels FS Store Root directory</em></span><span class="SemanticString"> 存储路径为前面 HDFS 创建好的路径（相当于修改 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">yarn-site</code></span><span class="SemanticString"> 的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">yarn.node-labels.fs-store.root-dir</code></span><span class="SemanticString"> 属性）：</span></span></p></div><div id="https://www.notion.so/453339e80b0740bd91b385a8756e102f" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e7efc88455c445d2b9227a27ba63fe48" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">重启 Yarn 服务。</span></span></p></div><h2 id="https://www.notion.so/9dc02ba86f2842b499226a00488fbf94" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9dc02ba86f2842b499226a00488fbf94"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. 添加 Node Labels</strong></span></span></h2><div id="https://www.notion.so/66729b69a4b24c9ab5aa1ff595a1b6f8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Node Lables 会根据我们指定的 label，将集群的节点划分为一个个 partition，一个节点只可以有一个 lable。如果不分配 lable，则节点默认属于 Default partition（即 partition=&quot;&quot;）。</span></span></p></div><div id="https://www.notion.so/ad8e8698429f44cf9a14cf3842c79a36" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这里我们添加 kunpeng 以及 dell 两种 label：</span></span></p></div><pre id="https://www.notion.so/f83e016297b74ee4b488851ccc474395" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>sudo -u yarn yarn rmadmin -addToClusterNodeLabels &quot;kunpeng(exclusive=true),dell(exclusive=true)&quot;</span></span></span></code></pre><div id="https://www.notion.so/af33aaa6016e4d4a9fb0e6a97868fca0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">exclusive 表示 partition 是否独占，默认为 true。两种配置的含义分别如下：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/321bd084981745799ef284f59adeb16a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">true</strong></span><span class="SemanticString">： containers 只会分配到完全匹配的节点上。例如，一个 partition 只能被 partition 指定为 x 的任务访问。如果任务不指定 label，则会分配到 Default partition 的节点上。</span></span></li></ul><div id="https://www.notion.so/377bbcce3864454382a29b77ce9d7a27" class="Image Image--Normal"><figure><a href="https://docs.cloudera.com/HDPDocuments/HDP2/HDP-2.3.6/bk_yarn_resource_mgt/content/figures/2/figures/exclusive_node_labels.png?width=624"><img src="https://docs.cloudera.com/HDPDocuments/HDP2/HDP-2.3.6/bk_yarn_resource_mgt/content/figures/2/figures/exclusive_node_labels.png?width=624" style="width:624px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/4d63b1929c44422d949c4fa10bbc6c08" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">false</strong></span><span class="SemanticString">：如果一个 partition 是非独占的，那么当有空闲资源时，也可以共享给 Default partition 下的任务。</span></span></li></ul><div id="https://www.notion.so/c9516821f4c140f8a8bc40ae63624f33" class="Image Image--Normal"><figure><a href="https://docs.cloudera.com/HDPDocuments/HDP2/HDP-2.3.6/bk_yarn_resource_mgt/content/figures/2/figures/non-exclusive_node_labels.png?width=624"><img src="https://docs.cloudera.com/HDPDocuments/HDP2/HDP-2.3.6/bk_yarn_resource_mgt/content/figures/2/figures/non-exclusive_node_labels.png?width=624" style="width:624px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/9f95bc225cfc484e87e6bba8ccc866ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">关于独占与非独占的区别，更具体的信息可以参考 HDP 的文档：</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.cloudera.com/HDPDocuments/HDP2/HDP-2.3.6/bk_yarn_resource_mgt/content/ch_node_labels.html">Chapter 5. Node Labels</a></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/f670530052914421aeb30af064e49006" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">绝大部分场景下，最好设置为独占，让分布式作业只跑在一种架构下，避免低配的机器与高配机器产生 “木桶原理” 的现象。</span></span></p></div><div id="https://www.notion.so/719d10ffd907444b85746f94593f2246" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果需要删除 label，则需要确保 label 没有分配到队列才能删除：</span></span></p></div><pre id="https://www.notion.so/255f5757ce104e98b83c1929c5f534cd" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>sudo -u yarn yarn rmadmin -removeFromClusterNodeLabels &quot;&lt;label&gt;[,&lt;label&gt;,...]&quot;</span></span></span></code></pre><div id="https://www.notion.so/2e67ed126ccf4d32bc8de3e1b3f0f510" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果需要查看创建的 label，执行下列命令：</span></span></p></div><pre id="https://www.notion.so/f359b1782c864e22962df62a8072b56c" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>sudo -u yarn yarn cluster --list-node-labels</span></span></span></code></pre><h2 id="https://www.notion.so/fe4de26ed9e64b0cb7b214fcd7c48b43" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/fe4de26ed9e64b0cb7b214fcd7c48b43"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. 节点分配 Label</strong></span></span></h2><div id="https://www.notion.so/b6603aa43859424fbeeb76f6ab76edc7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">节点分配 label 的语法如下：</span></span></p></div><pre id="https://www.notion.so/6f14ed4fd737440091535864985a76a0" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>sudo -u yarn yarn rmadmin -replaceLabelsOnNode &quot;node1[:port]=label1 node2=label2&quot; [-failOnUnknownNodes]</span></span></span></code></pre><div id="https://www.notion.so/23de5a14e6a646c5bcd21b00f76f1730" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果不指定 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[:prot]</code></span><span class="SemanticString"> ，就会分配给该节点上的全部 NM，从这里也可以看出，Node Labels 的作用粒度其实是在 NM 上，而非节点上，一个节点可以有多个 NM。</span></span></p></div><div id="https://www.notion.so/3e30d58fefaa43fcb433d595e1624c74" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果指定了 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">-failOnUnknownNodes</code></span><span class="SemanticString">，那么当命令中有未知节点时，命令会失败。</span></span></p></div><div id="https://www.notion.so/298886b4ec7247b684dd7801ba513a18" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果想要查看节点分配的 label，需要先获取节点的 ID，例如（下列信息来自 HDP 文档）：</span></span></p></div><pre id="https://www.notion.so/81f55960e5fe4c21aa7aeacff4d27692" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span> [root@node-1 /]# sudo -u yarn yarn node -list
 14/11/21 12:14:06 INFO impl.TimelineClientImpl: Timeline service address: http://node-1.example.com:8188/ws/v1/timeline/
 14/11/21 12:14:07 INFO client.RMProxy: Connecting to ResourceManager at node-1.example.com/240.0.0.10:8050
 Total Nodes:3
  Node-Id Node-State Node-Http-Address Number-of-Running-Containers
 node-3.example.com:45454 RUNNING node-3.example.com:50060 0
 node-1.example.com:45454 RUNNING node-1.example.com:50060 0
 node-2.example.com:45454 RUNNING node-2.example.com:50060 0</span></span></span></code></pre><div id="https://www.notion.so/b2e35cc1f6324bfca02f0b2512351501" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">然后根据节点 ID 获取节点的具体信息：</span></span></p></div><pre id="https://www.notion.so/ea14f8380d2d4ae79146f47ba8bd5691" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span> [root@node-1 /]# yarn node -status node-1.example.com:45454
 14/11/21 06:32:35 INFO impl.TimelineClientImpl: Timeline service address: http://node-1.example.com:8188/ws/v1/timeline/
 14/11/21 06:32:35 INFO client.RMProxy: Connecting to ResourceManager at node-1.example.com/240.0.0.10:8050
 Node Report :
  Node-Id : node-1.example.com:45454
  Rack : /default-rack
  Node-State : RUNNING
  Node-Http-Address : node-1.example.com:50060
  Last-Health-Update : Fri 21/Nov/14 06:32:09:473PST
  Health-Report :
  Containers : 0
  Memory-Used : 0MB
  Memory-Capacity : 1408MB
  CPU-Used : 0 vcores
  CPU-Capacity : 8 vcores
  Node-Labels : x</span></span></span></code></pre><h2 id="https://www.notion.so/8c8a6047deea427885956cf8a704d86c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/8c8a6047deea427885956cf8a704d86c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. 队列绑定 Label</strong></span></span></h2><div id="https://www.notion.so/61ceb728b06645d5971bf94e58092ad7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">NM 分配 node 有 </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Centralized</strong></span><span class="SemanticString"> 、</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Distributed</strong></span><span class="SemanticString"> 、</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Delegated-Centralized</strong></span><span class="SemanticString"> 这几种方式，Ambari 默认为第一种方式。</span></span></p></div><div id="https://www.notion.so/bd8cab338c8b4935ba66a60cdf14bc20" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Centralized</strong></span><span class="SemanticString">：节点与 label 的映射可以通过 RM 暴露的 CLI, REST 或者 RPC 进行配置。</span></span></p></div><div id="https://www.notion.so/62c4f84c38db45cd9be843f533f2396b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在 Ambari 的队列配置界面，配置 root 父队列占用 kunpeng、dell 的全部资源，同时设置任务不指定 label 时默认 label 为 kunpeng ：</span></span></p></div><div id="https://www.notion.so/8fcbc72f75d647d78166174f69539717" class="Image Image--Normal"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210224085711.png?width=1200"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210224085711.png?width=1200" style="width:1200px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f5e706f1a573478c931c33412ea03090" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">配置 haohan、default 队列各占 kunpeng、dell 一半资源：</span></span></p></div><div id="https://www.notion.so/9f9134d2aff3467d8535eee8e1337295" class="Image Image--Normal"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210223172131.png?width=1200"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210223172131.png?width=1200" style="width:1200px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e87f325c596b4405bacd1313072ddc85" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">子队列无需配置默认 label，默认会继承父队列的规则。Ambari 会按照 Yarn 的规则，自动生成相应的配置。</span></span></p></div><div id="https://www.notion.so/da69e6677f824f6c94a0ed1e7186652a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">最后点击保存并刷新队列：</span></span></p></div><div id="https://www.notion.so/b0f1c190b99e48b3b0f0f6051774803f" class="Image Image--Normal"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210223173253.png?width=624"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210223173253.png?width=624" style="width:624px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e98ed2cbdc2640178f3993d194d68902" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这里有一点需要注意，同个 label 在不同队列中也是需要指定百分比的，</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">不同队列相同 label 最终的比例之和需要等于 100%</strong></span><span class="SemanticString">，此时</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">队列之间的资源比例，仅作用于未指定 label 的节点上</strong></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/af8be87431274618b453619617a30d54" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">配置完毕之后，可以通过以下几种方式指定 label：</span></span></p></div><div id="https://www.notion.so/7e549a83b8fc4983a8e5225903077369" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">API 方式</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/eece09080b7f4d00b57d8e3506232d3f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ApplicationSubmissionContext.setNodeLabelExpression(..)</code></span><span class="SemanticString"> to set node label expression for all containers of the application.</span></span></li><li id="https://www.notion.so/a84e14cf3b1f421da20a6b72af15f6de" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ResourceRequest.setNodeLabelExpression(..)</code></span><span class="SemanticString"> to set node label expression for individual resource requests. This can overwrite node label expression set in ApplicationSubmissionContext</span></span></li><li id="https://www.notion.so/b323de9b8bf64c6e99d0a6320bcc28ad" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Specify </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">setAMContainerResourceRequest.setNodeLabelExpression</code></span><span class="SemanticString"> in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ApplicationSubmissionContext</code></span><span class="SemanticString"> to indicate expected node label for application master container.</span></span></li></ul><div id="https://www.notion.so/6981670320f54861972835d3ab685af8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Hadoop 运行 jar 包方式</strong></span><span class="SemanticString">：</span></span></p></div><pre id="https://www.notion.so/f8f5b423619344cbbd4cce2147e8c240" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>hadoop jar xxx.jar -Dmapreduce.job.node-label-expression=&quot;label1&quot; -Dmapreduce.job.queuename=&quot;queue1&quot;</span></span></span></code></pre><div id="https://www.notion.so/334f8adb94854d9cb796f7f3ae7d2ae2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Spark 可以通在 spark-submit 添加参数来指定 label</strong></span><span class="SemanticString">：</span></span></p></div><pre id="https://www.notion.so/d6a6ba962622453f963fcb6532ed7be9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span> --conf spark.yarn.am.nodeLabelExpression=label1 \
 --conf spark.yarn.executor.nodeLabelExpression=label1</span></span></span></code></pre><h2 id="https://www.notion.so/23e95c440ab346afb1b3417380d6d2c9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/23e95c440ab346afb1b3417380d6d2c9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4. 测试</strong></span></span></h2><div id="https://www.notion.so/b4bc3640bd6443b2919e4707263fbd40" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">执行 TPC-DS 项目来生成测试数据，在 hadoop 提交任务处指定 label，可以看到提交的 MR 作业都落在指定了 kunpeng 标签的单个节点上：</span></span></p></div><div id="https://www.notion.so/a65b8de7ccef48faa7b5cd585c3f2039" class="Image Image--Normal"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210224112641.png?width=1104"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210224112641.png?width=1104" style="width:1104px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/b5b002f51b314868b0e2db691fad438c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">参考文档</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/10f6f30bc70f44bfba4153406763114f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.cloudera.com/HDPDocuments/HDP2/HDP-2.3.6/bk_yarn_resource_mgt/content/ch_node_labels.html">Chapter 5. Node Labels</a></span></span></li><li id="https://www.notion.so/a134564029f04c2b9eece6e5d5f88bd5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://hadoop.apache.org/docs/r3.1.0/hadoop-yarn/hadoop-yarn-site/NodeLabel.html">YARN Node Labels</a></span></span></li><li id="https://www.notion.so/59f87d60e7c7443aadaecaf67db7afde" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.0.0/data-operating-system/content/configuring_node_labels.html">Configure Node Labels</a></span></span></li><li id="https://www.notion.so/f4602f40eb424893b500a9ab3025bf18" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.cnblogs.com/jiangxiaoxian/p/9412368.html">YARN label 特性 &amp; 指定队列及label提交任务</a></span></span></li></ul></article>
  <footer class="Footer">
  <div>&copy; Rianico‘s Blog 2019-2021</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>