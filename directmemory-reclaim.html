<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="å †å¤–å†…å­˜çš„å›æ”¶ä¸ PhantomReference">
  
  <meta name="description" content="å †å¤–å†…å­˜çš„å›æ”¶åŠåˆ©ç”¨ PhantonReference å®ç°å›æ”¶çš„æ–¹å¼">
  <meta property="og:description" content="å †å¤–å†…å­˜çš„å›æ”¶åŠåˆ©ç”¨ PhantonReference å®ç°å›æ”¶çš„æ–¹å¼">
  
  <meta property="og:type" content="blog">
  <title>å †å¤–å†…å­˜çš„å›æ”¶ä¸ PhantomReference</title>
  <!-- Favicon -->
  
  <link rel="shortcut icon" href="https://avatars1.githubusercontent.com/u/32795735?s=400&u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&v=4">
  
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span><img class="inline-img-icon" src="https://avatars1.githubusercontent.com/u/32795735?s=400&u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&v=4"></span> <span>Home</span></div>
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>ğŸ˜€</span> <span>About</span></div>
    </a>
    
    
  </nav>
  <header class="Header">
      
    <div class="Header__Cover">
        <img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4463e097-75a1-45d2-a554-79b330fd8b0e%2F%E8%83%8C%E6%99%AF1_2.jpg?table=block&id=b032989f-8e5b-4473-a043-397c48c1bb51">
      </div>
      
    <div class="Header__Spacer ">
    </div>
    
    <div class="Header__Icon"><span><img class="inline-img-icon" src="https://www.oracle.com/a/ocom/img/obic-java-cup.svg"></span></div>
    
    <h1 class="Header__Title">å †å¤–å†…å­˜çš„å›æ”¶ä¸ PhantomReference</h1>
        
    <div class="DateTagBar">
          
      <span class="DateTagBar__Item DateTagBar__Date">Posted on Sun, Aug 15, 2021</span>
          
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/Java.html">Java</a>
          </span>
          
        </div>
        
  </header>
      <article id="https://www.notion.so/b032989f8e5b4473a043397c48c1bb51" class="PageRoot PageRoot--FullWidth"><ul id="https://www.notion.so/499a422365d44eb1836ba97237bc1e85" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/37fa62f5eaae4ffcbcb03b6297da8fed"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">å…³äº JDK8 é‡Œçš„ Cleaner</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/263a5d5160884cf48a96f7f408fac2fc"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">å…³äº JDK9 åŠä¹‹åçš„ Cleaner</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/6ce244c420324750bb348414ea8abb30"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">æ³¨æ„äº‹é¡¹</strong></span></span></div></a></li></ul><div id="https://www.notion.so/322f3d6a93d54828bce2637705e3662a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">DirectMemory å¹¶ä¸å±äº Java è™šæ‹Ÿæœºè§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ç”±äº JDK1.4 ä¸­å¼•å…¥äº† nioï¼Œä¸€ç§åŸºäº channel ä¸ buffer çš„ I/O æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡æ“ä½œ JVM ä¸­çš„ DirectByteBuffer å¯¹è±¡ï¼Œä»è€Œè°ƒç”¨ Native å‡½æ•°åº“åœ¨å †å¤–åˆ†é…</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">å †å¤–å†…å­˜ï¼ˆDirectMemoryï¼‰</strong></span><span class="SemanticString">å¹¶è¿›è¡Œæ“ä½œï¼Œå¯ä»¥é¿å…å †å¤–åˆ°å †å†…å¯¹è±¡æ¥å›æ‹·è´çš„å¼€é”€ã€‚</span></span></p></div><div id="https://www.notion.so/dbd4da7cfd4e491d8dc9d9ed8c45a904" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¿™éƒ¨åˆ†å†…å­˜å¾€å¾€ä¹Ÿæ˜¯é€ æˆ OOM çš„åŸå› ï¼Œæœ€æ˜æ˜¾çš„ä¸€ä¸ªç‰¹å¾å°±æ˜¯å½“ JVM OOM æ—¶ï¼Œdump å‡ºæ¥çš„æ–‡ä»¶å´å¾ˆå°ã€‚</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/2aaeafc59eec4903a5b119bd0c0b287d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">XX:MaxDirectMemorySize</code></span><span class="SemanticString"> ç”¨äºé™å®šå †å¤–å†…å­˜çš„ä½¿ç”¨ï¼Œåœ¨ JDK8 ç‰ˆæœ¬ï¼Œå¦‚æœä¸æŒ‡å®š </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">XX:MaxDirectMemorySize</code></span><span class="SemanticString">ï¼Œåˆ™æœ€å¤§ä¸è¶…è¿‡å †å†…å­˜å¤§å°ã€‚</span></span></li></ul><div id="https://www.notion.so/fdf534f669284b5a9d8b64a05566c782" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¦‚æœä¸æ‰‹åŠ¨é‡Šæ”¾ï¼ŒDirectMemory å¾€å¾€åˆ°äº† Full GC æ‰ä¼šå›æ”¶ã€‚å…¶å®åœ¨è°ƒç”¨ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ByteBuffer.allocateDirect(int capacity)</code></span><span class="SemanticString"> åˆ†é…å †å¤–å†…å­˜æ—¶ä¼šæ·»åŠ å †å¤–å†…å­˜çš„é‡Šæ”¾é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/f54b707ebbb74cdcb43bfed031116da1" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â     public static ByteBuffer allocateDirect(int capacity) {
Â         return new DirectByteBuffer(capacity);
Â     }
Â 
Â     DirectByteBuffer(int cap) {                   // package-private
Â         // ...
Â         // æ–¹æ³•é‡Œä¼šè°ƒç”¨ System.gc() å°è¯•å›æ”¶å †å¤–å†…å­˜
Â         Bits.reserveMemory(size, cap);
Â         // ...
Â         // å°†è‡ªèº«çš„é‡Šæ”¾é€»è¾‘æ”¾å…¥ Cleaner ä¸­ï¼Œåˆ©ç”¨ PhantomReference ç‰¹æ€§é‡Šæ”¾å †å¤–å†…å­˜
Â         cleaner = Cleaner.create(this, new Deallocator(base, size, cap));
Â         att = null;
Â     }</span></span></span></code></pre><div id="https://www.notion.so/0ef91496e6ce4ce58544f19d565b3e59" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å…¶ä¸­ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Deallocator</code></span><span class="SemanticString"> æ˜¯ä¸€ä¸ª Runnableï¼Œé‡Šæ”¾å †å¤–å†…å­˜çš„é€»è¾‘å°±åœ¨å…¶ä¸­ï¼š</span></span></p></div><pre id="https://www.notion.so/33e57b52ec624276bcc67080d174cbd0" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â public void run() {
Â     if (address == 0) {
Â         // Paranoia
Â         return;
Â     }
Â     unsafe.freeMemory(address);
Â     address = 0;
Â     Bits.unreserveMemory(size, capacity);
Â }</span></span></span></code></pre><div id="https://www.notion.so/ed66bf3a9e1047b889e1bb652d47f816" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç»¼ä¸Šï¼Œå¯ä»¥çœ‹åˆ° JDK å¯¹äº DirectMemory çš„å›æ”¶ç…è´¹è‹¦å¿ƒï¼Œå…‰æ˜¯åˆ†é…å †å¤–å†…å­˜æ—¶å°±åšäº†ä¸¤ä¸ªä¿é™©æªæ–½ï¼š</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/ccdd5700a3cc4b3e8202a7350714ce53" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æ˜¾ç¤ºè°ƒç”¨ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">System.gc()</code></span><span class="SemanticString"> ï¼Œä½†ä¸€æ—¦è®¾ç½®äº† </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">XX:+DisableExplicitGC</code></span><span class="SemanticString"> åˆ™ä¼šå¤±æ•ˆï¼›</span></span></li><li id="https://www.notion.so/b98070b6d2924dac894adf09b896ffe3" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">å€ŸåŠ© PhantomReference æœºæŒ‡å®šå›æ”¶é€»è¾‘ï¼Œï¼Œä¸€æ—¦è¯¥ buffer æ²¡æœ‰å¼ºå¼•ç”¨æ—¶ä¼šè¢« JVM å›æ”¶ã€‚</span></span></li></ol><blockquote id="https://www.notion.so/c6398c67d83c41278975be1b5626e2b1" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">NOTEï¼šä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œä¸ºä»€ä¹ˆ JDK å¾ˆå¤šåœ°æ–¹æœ‰ç€å°†å˜é‡ç½®ä¸º null çš„æ“ä½œï¼Œå¯ä»¥ååŠ©æ›´å¥½çš„ GCã€‚</span></span></blockquote><div id="https://www.notion.so/cca062b324de4d86bbcb4e558af8ce5e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DirectBuffer</code></span><span class="SemanticString"> ä¹Ÿæä¾›äº†ä¸€ä¸ª cleaner æ¥å£ï¼Œå¯ä»¥è®©æˆ‘ä»¬è·å– Cleaner å¯¹è±¡ä¸»åŠ¨æ‰§è¡Œæ¸…ç†åŠ¨ä½œï¼š</span></span></p></div><pre id="https://www.notion.so/156deb06eb364fec922cb482af1f491f" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â ((DirectBuffer)byteBuffer).cleaner().clean();</span></span></span></code></pre><h3 id="https://www.notion.so/37fa62f5eaae4ffcbcb03b6297da8fed" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/37fa62f5eaae4ffcbcb03b6297da8fed"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">å…³äº JDK8 é‡Œçš„ Cleaner</strong></span></span></h3><div id="https://www.notion.so/c24bdd8541174a6bbf234ded5c3bcf49" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Cleaner ç»§æ‰¿äº† PhantomReferenceï¼Œè¿™æ˜¯ ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹å¯¹ PhantomReference çš„ä¸€ä¸ªæè¿°ï¼š</span></span></p></div><blockquote id="https://www.notion.so/a08d516f857e4d319fc62c17367159ac" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">è™šå¼•ç”¨ä¹Ÿç§°ä¸ºâ€œå¹½çµå¼•ç”¨â€æˆ–è€…â€œå¹»å½±å¼•ç”¨â€ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„ å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥å–å¾—ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™š å¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„åªæ˜¯ä¸ºäº†èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚åœ¨JDK 1.2ç‰ˆä¹‹åæä¾› äº†PhantomReferenceç±»æ¥å®ç°è™šå¼•ç”¨ã€‚</span></span></blockquote><div id="https://www.notion.so/70cdd7f864fd4d8d8457ff7cc6122972" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼ŒPhantomReference å¹¶ä¸å½±å“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸”æ— æ³•é€šè¿‡ PhantomReference è·å¾—ä»»ä½•å¯¹è±¡å¼•ç”¨ã€‚JVM </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">åœ¨å›æ”¶å¯¹è±¡æ—¶</strong></span><span class="SemanticString">ï¼Œå¦‚æœå‘ç°è¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªè™šå¼•ç”¨å¹¶ä¸”å¯å›æ”¶ï¼Œåˆ™ä¼šå°†å…¶åŠ å…¥ä¸€ä¸ª Reference é˜Ÿåˆ—ï¼ˆåˆ›å»º PhantomReference  æ—¶ä¼šä¼ å…¥ï¼‰ï¼Œçˆ¶ç±» Reference åˆ™ä¼šèµ·ä¸€ä¸ª </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ReferenceHandler</code></span><span class="SemanticString"> çº¿ç¨‹å»å¤„ç†é˜Ÿåˆ—é‡Œçš„å¯¹è±¡ã€‚</span></span></p></div><div id="https://www.notion.so/5e9748440c6e42f29d7a0c3503dcb18c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç¼–ç æ–¹å¼ï¼šè‡ªå®šä¹‰å¯¹è±¡ + Reference é˜Ÿåˆ— = PhantomReference åŒ…è£…ï¼š</span></span></p></div><pre id="https://www.notion.so/426712eca6e144acb8361375c1756fb5" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â ReferenceQueue&lt;Object&gt; referenceQueue = new ReferenceQueue&lt;&gt;();
Â Object obj = new Object();
Â PhantomReference&lt;Object&gt; phantomobj = new PhantomReference(obj, referenceQueue)</span></span></span></code></pre><div id="https://www.notion.so/64b133ffc48e4b0bad9b0f7a3f137a5c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç»“åˆ DirectByteBuffer å¯¹ Cleaner çš„ä½¿ç”¨å¯ä»¥çœ‹å‡º PhantomReference çš„ä¸€ä¸ªç»å…¸åº”ç”¨åœºæ™¯ï¼š</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ä¸€ä¸ªå¯¹è±¡ç¡®å®šä¸å†ä½¿ç”¨åï¼Œèƒ½å¤Ÿåœ¨å›æ”¶æ—¶äº§ç”Ÿä¸€ä¸ªé€šçŸ¥å¹¶æ‰§è¡ŒæŒ‡å®šæ“ä½œ</strong></span><span class="SemanticString">ã€‚</span></span></p></div><blockquote id="https://www.notion.so/cabc6e4c1c8a4ec99391208f3556624a" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">NOTEï¼š JVM è™½ç„¶æä¾›äº† finalized çš„æœºåˆ¶ï¼Œä½†æ‰§è¡Œè¯¥é€»è¾‘çš„æ˜¯ä¸€ä¸ªä½ä¼˜å…ˆçº§çº¿ç¨‹ï¼Œå¹¶ä¸ä¿è¯ä¸€å®šä¼šæ‰§è¡Œè¯¥æ“ä½œï¼Œå¹¶ä¸”åœ¨å…¶ä¸­æ”¾å…¥å¼€é”€è¾ƒå¤§çš„é€»è¾‘è¿˜ä¼šå½±å“ GCï¼Œå› æ­¤å€ŸåŠ© PhantomReference æ¥å®ç°å¯¹è±¡å›æ”¶æ—¶æ‰§è¡ŒæœŸæœ›æ“ä½œæ˜¯ä¸€ä¸ªæ›´ä¼˜çš„é€‰æ‹©ã€‚</span></span></blockquote><div id="https://www.notion.so/b6c88416c3244bf79733632128bf5fd2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">JDK æä¾›äº† </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sun.misc.Cleaner</code></span><span class="SemanticString"> ï¼Œè¯¥ç±»ç»§æ‰¿äº† </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PhantomReference</code></span><span class="SemanticString"> æ¥å£ï¼Œæ”¯æŒä¼ å…¥ä¸€ä¸ªå¯¹è±¡ä»¥åŠä¸€ä¸ª Runnable å¯¹è±¡ï¼š</span></span></p></div><pre id="https://www.notion.so/20338615916a4947ae50d7ddddcd0b2b" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â List&lt;Object&gt; objs = new ArrayList&lt;&gt;();
Â for (int i = 0; i &lt; 10; ++i) {
Â     Object obj = new Object();
Â     objs.add(obj);
Â     // ä¼ å…¥éœ€è¦è·Ÿè¸ªçš„å¯¹è±¡ä»¥åŠä¸å†å¼•ç”¨æ—¶æ‰§è¡Œçš„åŠ¨ä½œ
Â     Cleaner.create(obj, () -&gt; System.out.println(&quot;clearing...&quot;));
Â }
Â objs.clear();
Â System.gc();</span></span></span></code></pre><div id="https://www.notion.so/88753b203e5a4f00b85200f9b5c5548c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨å‘ç”Ÿ GC æ—¶ï¼Œå¦‚æœ Cleaner è·Ÿè¸ªçš„å¯¹è±¡è¢«å›æ”¶ï¼Œé‚£ä¹ˆ Cleaner ä¼šè¢«æŒªåˆ° Reference é˜Ÿåˆ—ä¸­ï¼Œæ‰§è¡Œ Runnable çš„é€»è¾‘ï¼š</span></span></p></div><pre id="https://www.notion.so/5936531d3c954c99ad74510493fe02df" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â // sun.misc.Cleaner#clean
Â public void clean() {
Â     if (remove(this)) {
Â         try {
Â             // æ‰§è¡Œ Runnable é€»è¾‘
Â             this.thunk.run();
Â         // ...
Â }

Â // java.lang.ref.Reference#tryHandlePending
Â // Reference ä¼šå¯åŠ¨ä¸€ä¸ª ReferenceHandler çº¿ç¨‹ä¸æ–­å¾ªç¯è°ƒç”¨ Cleaner é€»è¾‘
Â static boolean tryHandlePending(boolean waitForNotify) {
Â     Reference&lt;Object&gt; r;
Â     Cleaner c;
Â     // ...
Â     // Fast path for cleaners
Â     if (c != null) {
Â         c.clean();
Â         return true;
Â     }
Â     // ...
Â }</span></span></span></code></pre><h3 id="https://www.notion.so/263a5d5160884cf48a96f7f408fac2fc" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/263a5d5160884cf48a96f7f408fac2fc"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">å…³äº JDK9 åŠä¹‹åçš„ Cleaner</strong></span></span></h3><div id="https://www.notion.so/5d174aa9f34d4435994b83c505555183" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä» JDK9 å¼€å§‹ï¼Œä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡å¯¹åº”ä¸€ä¸ª Cleanerï¼Œä¸€ä¸ª Cleaner å¯ä»¥é‡å¤æ³¨å†Œå¯¹è±¡åŠ actionï¼š</span></span></p></div><pre id="https://www.notion.so/356a3890bec1453ba8f6d31cb7c93836" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â public class CleanerTest implements AutoCloseable {
Â 
Â 
Â     // A cleaner, preferably one shared within a library
Â     private static final Cleaner CLEANER = Cleaner.create();
Â 
Â     static class State implements Runnable {
Â 
Â         State() {
Â             // initialize State needed for cleaning action
Â         }
Â 
Â         @Override
Â         public void run() {
Â             // cleanup action accessing State, executed at most once
Â             System.out.println(&quot;clearing...&quot;);
Â         }
Â     }
Â 
Â     private final Cleaner.Cleanable cleanable;
Â 
Â     public CleanerTest() {
Â         State state = new State();
Â         this.cleanable = CLEANER.register(this, state);
Â     }
Â 
Â     @Override
Â     public void close() {
Â         cleanable.clean();
Â     }
Â 
Â }</span></span></span></code></pre><div id="https://www.notion.so/1a7c1b58cc5a465881ec04ee1f04237d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä¸€ä¸ª Cleaner å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœåˆ›å»ºè¿‡å¤šçš„ cleanerï¼Œå¯èƒ½ä¼šæœ‰ä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ã€‚</span></span></p></div><div id="https://www.notion.so/9181b4037cb14752b97cc6a0018a83a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä¸Šè¿°å®˜æ–¹ä¾‹å­ä¸­è¿˜ç”¨åˆ°äº† </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">AutoCloseable</code></span><span class="SemanticString"> æ¥å£ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥åœ¨ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">try-with-resource</code></span><span class="SemanticString"> è¯­æ³•ä¸­ä½¿ç”¨ã€‚å®˜æ–¹çš„è¯´æ³•æ˜¯å›æ”¶èµ„æºæœ€é«˜æ•ˆçš„æ–¹å¼æ—¶ä¸»åŠ¨å»è°ƒç”¨æ¸…ç†æ“ä½œï¼Œå¹¶ä¸”è¯¥æ“ä½œç›´åˆ°å˜ä¸º phantom reachable  æ—¶æœ€å¤šåªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼ˆå³ä½¿æ˜¾ç¤ºè°ƒç”¨ï¼‰ã€‚</span></span></p></div><h3 id="https://www.notion.so/6ce244c420324750bb348414ea8abb30" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/6ce244c420324750bb348414ea8abb30"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">æ³¨æ„äº‹é¡¹</strong></span></span></h3><div id="https://www.notion.so/49a8868709054df889af01fb68300686" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Cleaner çš„ action ä¸å¯ä»¥æŒ‡å‘æ³¨å†Œ/åŒ…è£…çš„å¯¹è±¡</strong></span><span class="SemanticString">ï¼Œä¼šå¯¼è‡´å¯¹è±¡æ— æ³•å˜ä¸º phantom reachableï¼Œä»è€Œæ— æ³•è‡ªåŠ¨è°ƒç”¨ actionã€‚</span></span></p></div><div id="https://www.notion.so/952005ce60b04ff7a481e549f5625a3b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è™½ç„¶æ³¨å†Œæ—¶ä¹Ÿå¯ä»¥ä¼ é€’ä¸€ä¸ª lambda è¡¨è¾¾å¼ï¼Œä½†è¿™æ ·å¾€å¾€å¾ˆå®¹æ˜“å¼•ç”¨åˆ°æ³¨å†Œå¯¹è±¡ï¼Œå¯¼è‡´ä¸Šé¢æåˆ°çš„é—®é¢˜ï¼Œä½¿ç”¨ä¸€ä¸ªé™æ€å†…éƒ¨ç±»å¯ä»¥æ¯”è¾ƒå¥½çš„é˜²æ­¢è¿™ç±»äº‹æƒ…å‘ç”Ÿï¼Œå³ä½¿æœ‰å¤–éƒ¨å¼•ç”¨ï¼Œä¹Ÿåªèƒ½è®¿é—®åˆ°ä¸ç±»ç›¸å…³çš„é™æ€å¤–éƒ¨å˜é‡ã€‚</span></span></p></div><div id="https://www.notion.so/54efa68971cb4b05ae40e5a968dc7c25" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨æ‰§è¡Œ action çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°çš„å¼‚å¸¸éƒ½ä¼šè¢«å¿½ç•¥ï¼Œæ‰§è¡Œ action çš„çº¿ç¨‹åŠå…¶ä»– action éƒ½ä¸å—å½±å“ã€‚</span></span></p></div><div id="https://www.notion.so/3030e2038d3445ae9dd08d0b57b735d0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.oracle.com/javase/9/docs/api/java/lang/System.html#exit-int-"><code class="SemanticString__Fragment SemanticString__Fragment--Code">System.exit</code></a></span><span class="SemanticString">  æ—¶æ— æ³•ä¿è¯æ‰€æœ‰çš„ action ä¸€å®šä¼šè¢«æ‰§è¡Œã€‚</span></span></p></div></article>
  <footer class="Footer">
        <div>&copy; Rianicoâ€˜s Blog 2019</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>