<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="ListenerBus æ¶ˆæ¯æ€»çº¿">
  
  <meta name="description" content="è§£è¯» Spark 3.0.0 çš„æ¶ˆæ¯æ€»çº¿æºç ">
  <meta property="og:description" content="è§£è¯» Spark 3.0.0 çš„æ¶ˆæ¯æ€»çº¿æºç ">
  
  <meta property="og:type" content="blog">
  <title>ListenerBus æ¶ˆæ¯æ€»çº¿</title>
  <!-- Favicon -->
  
  <link rel="shortcut icon" href="https://avatars1.githubusercontent.com/u/32795735?s=400&u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&v=4">
  
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span><img class="inline-img-icon" src="https://avatars1.githubusercontent.com/u/32795735?s=400&u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&v=4"></span> <span>Home</span></div>
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>ğŸ˜€</span> <span>About</span></div>
    </a>
    
    
  </nav>
  <header class="Header">
      
    <div class="Header__Cover">
        <img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc5f33405-3269-47ac-96a2-fbcb8271d259%2Fphoto-1509910110001-4e756f86fbd3.jfif?table=block&id=334613e3-375e-4665-86da-bef89b70ed1a">
      </div>
      
    <div class="Header__Spacer ">
    </div>
    
    <div class="Header__Icon"><span><img class="inline-img-icon" src="https://raw.githubusercontent.com/Rianico/Image/master/Avator/sparkles%20(1).png"></span></div>
    
    <h1 class="Header__Title">ListenerBus æ¶ˆæ¯æ€»çº¿</h1>
        
    <div class="DateTagBar">
          
      <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Jun 12, 2021</span>
          
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--default">
            <a href="tag/Spark.html">Spark</a>
          </span>
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/Scala.html">Scala</a>
          </span>
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--green">
            <a href="tag/æºç .html">æºç </a>
          </span>
          
        </div>
        
  </header>
      <article id="https://www.notion.so/334613e3375e466586dabef89b70ed1a" class="PageRoot PageRoot--FullWidth"><ul id="https://www.notion.so/28f743556e46487e8e454c4919630b8b" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/48a62070a5f643b491f7b630f4c1e956"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ListenerBus æ¶ˆæ¯æ€»çº¿</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/ce4497d8cb7044e583725d8ab7effa25"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1. ListenerBus æ¦‚è¿°</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/ddd352b694cc46b6bb143738ce2a23cd"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. Listener æ¦‚è¿°</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/adf590f3748a480e92613d63497a51b3"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. äº‹ä»¶æŠ•é€’</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/8e535ba343284197be09ed47ae1cbbd7"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4. å¦‚ä½•ä½¿ç”¨æ¶ˆæ¯æ€»çº¿</strong></span></span></div></a></li></ul><h2 id="https://www.notion.so/48a62070a5f643b491f7b630f4c1e956" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/48a62070a5f643b491f7b630f4c1e956"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ListenerBus æ¶ˆæ¯æ€»çº¿</strong></span></span></h2><div id="https://www.notion.so/dce6748be6684c29b2d4819cf58ee7ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Spark ç‰ˆæœ¬</strong></span><span class="SemanticString">ï¼š3.0.0</span></span></p></div><h2 id="https://www.notion.so/ce4497d8cb7044e583725d8ab7effa25" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/ce4497d8cb7044e583725d8ab7effa25"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1. ListenerBus æ¦‚è¿°</strong></span></span></h2><div id="https://www.notion.so/6e0dcee6bd3143f998f0b19cf2f4c41c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ListenerBus æ˜¯ Spark çš„æ¶ˆæ¯æ€»çº¿æ¥å£ï¼Œä¼šç»´æŠ¤ä¸€ä¸ª Listener é˜Ÿåˆ—ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€ Event åˆ†å‘åŠŸèƒ½ï¼Œå°†äº‹ä»¶åˆ†å‘ç»™æ³¨å†Œäº†çš„ Listenerï¼Œäº‹ä»¶çš„å…·ä½“å¤„ç†é€»è¾‘åˆ™äº¤ç”± Listener è‡ªè¡Œå®ç°ï¼Œå…¶ç»§æ‰¿ç»“æ„å¦‚ä¸‹ï¼š</span></span></p></div><div id="https://www.notion.so/aaa67097798a4bc8b4877c9dc007c5ab" class="Image Image--PageWidth"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/image-20210611194451769.png"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/image-20210611194451769.png" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/9e85286f8cec48dbb1d18584dda98aa2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Spark 2.3 å¼€å§‹ä¸º Listener æ·»åŠ äº† Event å¤„ç†æ—¶é—´çš„ç»Ÿè®¡åŠŸèƒ½ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æŸ¥çœ‹å„ä¸ª Event çš„å¤„ç†æ—¶é—´ï¼Œèƒ½å¤Ÿå¸®åŠ©å¼€å‘å‘˜äººå¿«é€Ÿå®šä½ç“¶é¢ˆã€‚</span></span></p></div><div id="https://www.notion.so/69705c63168e42808e92f6f0e4579061" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Listener çš„æ—¶é—´ç»Ÿè®¡åŠŸèƒ½é€šè¿‡ </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">spark.scheduler.listenerbus.logSlowEvent</em></span><span class="SemanticString">ã€</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">spark.scheduler.listenerbus.logSlowEvent.threshold</em></span><span class="SemanticString"> å‚æ•°æ§åˆ¶ï¼Œéœ€è¦ ListenerBus å­ç±»è‡ªè¡Œå®ç° </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.util.ListenerBus#getTimer</code></span><span class="SemanticString">  æ–¹æ³•ï¼Œæ­¤å¤„ä¸æ˜¯é‡ç‚¹ï¼Œæš‚ä¸”ä¸å…³æ³¨ã€‚</span></span></p></div><div id="https://www.notion.so/e9327a4743f4412eb4cc7ffed5c6b11f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ListenerBus éœ€è¦å…³æ³¨çš„ä»£ç å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/5b4cd1028cf146aa9dc0bcd6ba41a1ba" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   private[this] val listenersPlusTimers = new CopyOnWriteArrayList[(L, Option[Timer])]
Â 
Â   // Marked `private[spark]` for access in tests.
Â   private[spark] def listeners = listenersPlusTimers.asScala.map(_._1).asJava
Â 
Â   ......
Â   /**
Â    * Add a listener to listen events. This method is thread-safe and can be called in any thread.
Â    */
Â   final def addListener(listener: L): Unit = {
Â     listenersPlusTimers.add((listener, getTimer(listener)))
Â   }
Â 
Â   /**
Â    * Remove a listener and it won&#x27;t receive any events. This method is thread-safe and can be called
Â    * in any thread.
Â    */
Â   final def removeListener(listener: L): Unit = {
Â     listenersPlusTimers.asScala.find(_._1 eq listener).foreach { listenerAndTimer =&gt;
Â       listenersPlusTimers.remove(listenerAndTimer)
Â     }
Â   }
Â 
Â   /**
Â    * Remove all listeners and they won&#x27;t receive any events. This method is thread-safe and can be
Â    * called in any thread.
Â    */
Â   final def removeAllListeners(): Unit = {
Â     listenersPlusTimers.clear()
Â   }
Â 
Â   /**
Â    * This can be overridden by subclasses if there is any extra cleanup to do when removing a
Â    * listener.  In particular AsyncEventQueues can clean up queues in the LiveListenerBus.
Â    */
Â   def removeListenerOnError(listener: L): Unit = {
Â     removeListener(listener)
Â   }
Â 
Â 
Â   /**
Â    * Post the event to all registered listeners. The `postToAll` caller should guarantee calling
Â    * `postToAll` in the same thread for all events.
Â    */
Â   def postToAll(event: E): Unit = {
Â     // JavaConverters can create a JIterableWrapper if we use asScala.
Â     // However, this method will be called frequently. To avoid the wrapper cost, here we use
Â     // Java Iterator directly.
Â     val iter = listenersPlusTimers.iterator
Â     while (iter.hasNext) {
Â       val listenerAndMaybeTimer = iter.next()
Â       val listener = listenerAndMaybeTimer._1
Â       val maybeTimer = listenerAndMaybeTimer._2
Â       val maybeTimerContext = if (maybeTimer.isDefined) {
Â         maybeTimer.get.time()
Â       } else {
Â         null
Â       }
Â       lazy val listenerName = Utils.getFormattedClassName(listener)
Â       try {
Â         doPostEvent(listener, event)
Â         if (Thread.interrupted()) {
Â           // We want to throw the InterruptedException right away so we can associate the interrupt
Â           // with this listener, as opposed to waiting for a queue.take() etc. to detect it.
Â           throw new InterruptedException()
Â         }
Â       } catch {
Â         case ie: InterruptedException =&gt;
Â           logError(s&quot;Interrupted while posting to ${listenerName}. Removing that listener.&quot;, ie)
Â           removeListenerOnError(listener)
Â         case NonFatal(e) if !isIgnorableException(e) =&gt;
Â           logError(s&quot;Listener ${listenerName} threw an exception&quot;, e)
Â       } finally {
Â         if (maybeTimerContext != null) {
Â           val elapsed = maybeTimerContext.stop()
Â           if (logSlowEventEnabled &amp;&amp; elapsed &gt; logSlowEventThreshold) {
Â             logInfo(s&quot;Process of event ${redactEvent(event)} by listener ${listenerName} took &quot; +
Â               s&quot;${elapsed / 1000000000d}s.&quot;)
Â           }
Â         }
Â       }
Â     }
Â   }
Â 
Â   /**
Â    * Post an event to the specified listener. `onPostEvent` is guaranteed to be called in the same
Â    * thread for all listeners.
Â    */
Â   protected def doPostEvent(listener: L, event: E): Unit</span></span></span></code></pre><div id="https://www.notion.so/71dc89622aa34c5d91712b07366d87e1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ° ListenerBus ç»´æŠ¤äº†ä¸€ä¸ªå¸¦æ‰§è¡Œæ—¶é—´ç»Ÿè®¡åŠŸèƒ½çš„é˜Ÿåˆ— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">listenersPlusTimers</code></span><span class="SemanticString"> ä»¥åŠä¸å¸¦æ—¶é—´ç»Ÿè®¡åŠŸèƒ½çš„é˜Ÿåˆ— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">listeners</code></span><span class="SemanticString"> ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åŒä¸€æ¡é˜Ÿåˆ—ï¼Œåè€…ç”¨äºæµ‹è¯•ä½¿ç”¨ã€‚</span></span></p></div><div id="https://www.notion.so/1f78d92a16574688b89822d3dbf28e70" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ListenerBus æä¾›äº†æ·»åŠ ã€ç§»é™¤ listener çš„å¸¸ç”¨åŠŸèƒ½ï¼Œä»£ç æ¯”è¾ƒç®€å•ï¼Œæ­¤å¤„ä¸åšèµ˜è¿°ï¼Œé‡ç‚¹å…³æ³¨ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">postToAll</code></span><span class="SemanticString"> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šå°†éå†æ³¨å†Œçš„ Listenerï¼Œå¹¶å°† Event æŠ•é€’ç»™å„ä¸ª Listenerã€‚</span></span></p></div><div id="https://www.notion.so/26185c7d5c324de388d63795b4212b65" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¿™é‡Œéœ€è¦è¯´æ˜ä¸‹ï¼Œæ¯ä¸ª ListenerBus å­ç±»éƒ½ä¼šæŒæœ‰å„è‡ªçš„ Listener ç±»å‹ï¼Œå¹¶ä¸”éƒ½ä¼šå®ç°å„è‡ªçš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.util.ListenerBus#doPostEvent</code></span><span class="SemanticString"> æ–¹æ³•ï¼Œé€šå¸¸å°±æ˜¯å°† Event ç›´æ¥æŠ•é€’ç»™ Listenerï¼Œä»¥ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SparkListenerBus</code></span><span class="SemanticString"> ä¸ºä¾‹ï¼Œå…¶å®å®ç°å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/1b0375d5231d4f61b822ab7385538f80" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â private[spark] trait SparkListenerBus
Â   extends ListenerBus[SparkListenerInterface, SparkListenerEvent] {
Â 
Â   protected override def doPostEvent(
Â       listener: SparkListenerInterface,
Â       event: SparkListenerEvent): Unit = {
Â     event match {
Â       case stageSubmitted: SparkListenerStageSubmitted =&gt;
Â         listener.onStageSubmitted(stageSubmitted)
Â       case stageCompleted: SparkListenerStageCompleted =&gt;
Â         listener.onStageCompleted(stageCompleted)
Â       case jobStart: SparkListenerJobStart =&gt;
Â         listener.onJobStart(jobStart)
Â       // åç»­ä»£ç çœç•¥...</span></span></span></code></pre><div id="https://www.notion.so/efbf8bd69aa343d186444fdc26c96eb2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¿™ç§ç»“æ„æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ç›‘å¬è€…æ¨¡å¼ï¼Œå„ä¸ª ListenerBus å­ç±»åªéœ€è¦åœ¨ doPostEvent æ–¹æ³•ä¸­ä¸“æ³¨äºè‡ªå·±å…³å¿ƒçš„ Event æŠ•é€’å³å¯ï¼Œåç»­ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰©å±•å…³å¿ƒçš„äº‹ä»¶ã€‚</span></span></p></div><h2 id="https://www.notion.so/ddd352b694cc46b6bb143738ce2a23cd" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/ddd352b694cc46b6bb143738ce2a23cd"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. Listener æ¦‚è¿°</strong></span></span></h2><div id="https://www.notion.so/b5199c4e7d564471a08a1d0651f63216" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è™½ç„¶ ListenerBus ç»´æŠ¤äº†ä¸€ç»„æ³¨å†Œçš„ Listenerï¼Œä½†å¹¶æ²¡æœ‰ä¸ºå…¶å®šä¹‰ä¸€ä¸ªå…¬å…±çš„ Listener æ¥å£ï¼Œä»å…¶å®šä¹‰ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼š</span></span></p></div><pre id="https://www.notion.so/167fb6a8cc4d4270bee729608f4721ff" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â private[spark] trait ListenerBus[L &lt;: AnyRef, E] extends Logging {
Â   ...
Â }</span></span></span></code></pre><div id="https://www.notion.so/8ce657931c494b86aa772af6d6ea24ec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å…¶å®å„ä¸ª ListenerBus éƒ½æœ‰å„è‡ªä¸åŒçš„ Listener ç±»å‹ï¼Œè¿™é‡Œä»¥æœ€å¸¸ç”¨çš„äº‹ä»¶æ€»çº¿ SparkListenerBusã€äº‹ä»¶ç›‘å¬å™¨ SparkListener ä»¥åŠäº‹ä»¶ç±»å‹ SparkListenerEvent ä¸¾ä¾‹è¯´æ˜ã€‚</span></span></p></div><div id="https://www.notion.so/a576d158f5c84fbd9e94f6f5e022b729" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æŸ¥çœ‹ SparkListenerBus å®šä¹‰å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/698f02d259684350bf4d169ee5af617d" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â private[spark] trait SparkListenerBus
Â   extends ListenerBus[SparkListenerInterface, SparkListenerEvent] {
Â   ...
Â }</span></span></span></code></pre><div id="https://www.notion.so/4a5dedc76a454b8e9d304b54913464c5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ° SparkListenerBus æŒæœ‰çš„æ˜¯ä¸€ä¸ª SparkListenerInterface ç±»å‹çš„ Listenerï¼Œè¿™ä¸ªæ¥å£çš„å®ç°ç±»æœ‰å¾ˆå¤šï¼Œå…¶ä¸­æœ€å¸¸è§çš„å°±æ˜¯ SparkListenerï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/5b3338e8796b4076998b3771721d1617" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â @DeveloperApi
Â abstract class SparkListener extends SparkListenerInterface {
Â   override def onStageCompleted(stageCompleted: SparkListenerStageCompleted): Unit = { }
Â 
Â   override def onStageSubmitted(stageSubmitted: SparkListenerStageSubmitted): Unit = { }
Â   ...
Â }</span></span></span></code></pre><div id="https://www.notion.so/9598e035e1e4419d8da414eea99ece03" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å…¶ä¸­æ¯ä¸ª </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">onXXX</code></span><span class="SemanticString"> æ–¹æ³•éƒ½å¯¹åº”äº† Spark åœ¨è¿è¡Œæ—¶å„ä¸ªé˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯ä¸ªç”Ÿå‘½å‘¨æœŸå…³å¿ƒçš„äº‹ä»¶ä¹Ÿä¸åŒï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/a4b89c15a5b7418f98dd3fcad1cb2efe" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â @DeveloperApi
Â case class SparkListenerStageCompleted(stageInfo: StageInfo) extends SparkListenerEvent</span></span></span></code></pre><div id="https://www.notion.so/ee87f24a51f74acbb176cbfe4f623745" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®è¿™äº›äº‹ä»¶éƒ½æ˜¯ SparkListenerEvent çš„å®ç°ã€‚</span></span></p></div><h2 id="https://www.notion.so/adf590f3748a480e92613d63497a51b3" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/adf590f3748a480e92613d63497a51b3"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. äº‹ä»¶æŠ•é€’</strong></span></span></h2><div id="https://www.notion.so/1316d5f5a91d4a4383fbfe1006f2983a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¤–éƒ¨ç³»ç»Ÿä¹Ÿæ˜¯é€šè¿‡ ListenerBus æ¥æŠ•é€’ Event çš„ï¼Œä»¥ SparkContext ä¸ºä¾‹ï¼Œå…¶ç»´æŠ¤äº†ä¸€ä¸ª _listenerBus å˜é‡ï¼š</span></span></p></div><pre id="https://www.notion.so/e8c972bcd4774688bf20f3f613487fd8" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â private var _listenerBus: LiveListenerBus = _
Â _listenerBus = new LiveListenerBus(_conf)</span></span></span></code></pre><div id="https://www.notion.so/483b0521b9cc43288a8d1645f61a1f99" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Spark 2.3 ç‰ˆæœ¬ä¹‹å‰ï¼ŒLiveListenerBus ä¹Ÿæ˜¯ ListenerBus çš„å­ç±»ï¼Œä» 2.3 å¼€å§‹å‰¥ç¦»äº†å‡ºæ¥ï¼Œæ”¹ä¸ºå­˜å‚¨å¤šä¸ª </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">org.apache.spark.scheduler.AsyncEventQueue</em></span><span class="SemanticString">ï¼ˆå…¶çˆ¶ç±»æ­£æ˜¯ </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">SparkListenerBus</em></span><span class="SemanticString">ï¼‰å¯¹è±¡ï¼Œç”± SparkContext æŒ‰éœ€æ·»åŠ ã€‚</span></span></p></div><div id="https://www.notion.so/5ba829588a404ea5aa61c76c3b9fba1b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æŸ¥çœ‹ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.SparkContext#postApplicationEnd</code></span><span class="SemanticString"> æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒSparkContext è°ƒç”¨äº† LiveListenerBus çš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">post()</code></span><span class="SemanticString"> æ–¹æ³•ï¼š</span></span></p></div><pre id="https://www.notion.so/106c6bd8c9a8463b9f10acc301eb588d" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   /** Post the application start event */
Â   private def postApplicationStart(): Unit = {
Â     // Note: this code assumes that the task scheduler has been initialized and has contacted
Â     // the cluster manager to get an application ID (in case the cluster manager provides one).
Â     listenerBus.post(SparkListenerApplicationStart(appName, Some(applicationId),
Â       startTime, sparkUser, applicationAttemptId, schedulerBackend.getDriverLogUrls,
Â       schedulerBackend.getDriverAttributes))
Â     _driverLogger.foreach(_.startSync(_hadoopConfiguration))
Â   }</span></span></span></code></pre><div id="https://www.notion.so/1e67cb70a7f7422cb6c1434c1a4ac1d4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">post()</code></span><span class="SemanticString"> æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/3a921894e6a146488e3f8edf186c99f0" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   /** Post an event to all queues. */
Â   def post(event: SparkListenerEvent): Unit = {
Â     if (stopped.get()) {
Â       return
Â     }
Â 
Â     metrics.numEventsPosted.inc()
Â 
Â     // If the event buffer is null, it means the bus has been started and we can avoid
Â     // synchronization and post events directly to the queues. This should be the most
Â     // common case during the life of the bus.
Â     if (queuedEvents == null) {
Â       postToQueues(event)
Â       return
Â     }
Â 
Â     // Otherwise, need to synchronize to check whether the bus is started, to make sure the thread
Â     // calling start() picks up the new event.
Â     synchronized {
Â       if (!started.get()) {
Â         queuedEvents += event
Â         return
Â       }
Â     }
Â 
Â     // If the bus was already started when the check above was made, just post directly to the
Â     // queues.
Â     postToQueues(event)
Â   }</span></span></span></code></pre><div id="https://www.notion.so/11c999f265d34e1e9735ad713ff253bc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å…¶ä¸­ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">postToQueues</code></span><span class="SemanticString"> å®é™…ä¸Šå°±æ˜¯å°†äº‹ä»¶æŠ•é€’åˆ° </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">AsyncEventQueue</em></span><span class="SemanticString">ï¼š</span></span></p></div><pre id="https://www.notion.so/a2cc640448d8462cb7cd11af43e989c1" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   private def postToQueues(event: SparkListenerEvent): Unit = {
Â     val it = queues.iterator()
Â     while (it.hasNext()) {
Â       it.next().post(event)
Â     }
Â   }</span></span></span></code></pre><div id="https://www.notion.so/fbfd0f7dd19943eab9ec361c92d302aa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å†æ¥çœ‹ä¸‹ </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">AsyncEventQueue</em></span><span class="SemanticString"> çš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">post()</code></span><span class="SemanticString"> æ–¹æ³•ï¼š</span></span></p></div><pre id="https://www.notion.so/39bf3709468941c691bc941eb297954b" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   def post(event: SparkListenerEvent): Unit = {
Â     if (stopped.get()) {
Â       return
Â     }
Â 
Â     eventCount.incrementAndGet()
Â     if (eventQueue.offer(event)) {
Â       return
Â     }
Â 
Â     eventCount.decrementAndGet()
Â     droppedEvents.inc()
Â     droppedEventsCounter.incrementAndGet()
Â     if (logDroppedEvent.compareAndSet(false, true)) {
Â       // Only log the following message once to avoid duplicated annoying logs.
Â       logError(s&quot;Dropping event from queue $name. &quot; +
Â         &quot;This likely means one of the listeners is too slow and cannot keep up with &quot; +
Â         &quot;the rate at which tasks are being started by the scheduler.&quot;)
Â     }
Â     logTrace(s&quot;Dropping event $event&quot;)
Â 
Â     val droppedEventsCount = droppedEventsCounter.get
Â     val droppedCountIncreased = droppedEventsCount - lastDroppedEventsCounter
Â     val lastReportTime = lastReportTimestamp.get
Â     val curTime = System.currentTimeMillis()
Â     // Don&#x27;t log too frequently
Â     if (droppedCountIncreased &gt; 0 &amp;&amp; curTime - lastReportTime &gt;= LOGGING_INTERVAL) {
Â       // There may be multiple threads trying to logging dropped events,
Â       // Use &#x27;compareAndSet&#x27; to make sure only one thread can win.
Â       if (lastReportTimestamp.compareAndSet(lastReportTime, curTime)) {
Â         val previous = new java.util.Date(lastReportTime)
Â         lastDroppedEventsCounter = droppedEventsCount
Â         logWarning(s&quot;Dropped $droppedCountIncreased events from $name since &quot; +
Â           s&quot;${if (lastReportTime == 0) &quot;the application started&quot; else s&quot;$previous&quot;}.&quot;)
Â       }
Â     }
Â   }</span></span></span></code></pre><div id="https://www.notion.so/84134707ec334810a370d4086d48fbfc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼Œ</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">AsyncEventQueue</em></span><span class="SemanticString"> ä¼šå°†æ¥æ”¶åˆ°çš„äº‹ä»¶æ”¾åˆ°ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—é‡Œï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æŒç»­æ¶ˆè´¹è¿™ä¸ªé˜Ÿåˆ—é‡Œçš„äº‹ä»¶ï¼š</span></span></p></div><pre id="https://www.notion.so/6910883a618a49d5bb0322e18e995970" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   private val dispatchThread = new Thread(s&quot;spark-listener-group-$name&quot;) {
Â     setDaemon(true)
Â     override def run(): Unit = Utils.tryOrStopSparkContext(sc) {
Â       dispatch()
Â     }
Â   }
Â 
Â   private def dispatch(): Unit = LiveListenerBus.withinListenerThread.withValue(true) {
Â     var next: SparkListenerEvent = eventQueue.take()
Â     while (next != POISON_PILL) {
Â       val ctx = processingTime.time()
Â       try {
Â         super.postToAll(next)
Â       } finally {
Â         ctx.stop()
Â       }
Â       eventCount.decrementAndGet()
Â       next = eventQueue.take()
Â     }
Â     eventCount.decrementAndGet()
Â   }</span></span></span></code></pre><div id="https://www.notion.so/2f869a147ac146f0bf20473d7e40a123" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">é€šè¿‡ Spark UI ç•Œé¢ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ° &quot;spark-listener-group-$name&quot; çº¿ç¨‹ï¼š</span></span></p></div><div id="https://www.notion.so/53341052cafd483ab945ef30015b642d" class="Image Image--PageWidth"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/image-20210611222728321.png"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/image-20210611222728321.png" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/eaa413e0b9ee4718b864f9975ad8ff47" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ­¤å¤„æ³¨æ„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dispatch()</code></span><span class="SemanticString"> æ–¹æ³•é‡Œçš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">super.postToAll(next)</code></span><span class="SemanticString">ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¹Ÿè°ƒç”¨äº†çˆ¶ç±» ListenerBus çš„äº‹ä»¶æŠ•é€’æ–¹æ³•ï¼Œå°† Event åˆ†å‘ç»™äº†å…¶ä»–æ‰€æœ‰ Listenerã€‚</span></span></p></div><h2 id="https://www.notion.so/8e535ba343284197be09ed47ae1cbbd7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/8e535ba343284197be09ed47ae1cbbd7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">4. å¦‚ä½•ä½¿ç”¨æ¶ˆæ¯æ€»çº¿</strong></span></span></h2><div id="https://www.notion.so/4f14ca04ac004432b60d035752d5bb96" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Spark å¯¹æ¶ˆæ¯æ€»çº¿è¿›è¡Œäº†é«˜åº¦å°è£…ï¼Œå†å›é¡¾ä¸‹ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.SparkContext#postApplicationEnd</code></span><span class="SemanticString"> æ–¹æ³•ï¼š</span></span></p></div><pre id="https://www.notion.so/ff0d969683c2436c877dd7d35c109d3f" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   /** Post the application start event */
Â   private def postApplicationStart(): Unit = {
Â     // Note: this code assumes that the task scheduler has been initialized and has contacted
Â     // the cluster manager to get an application ID (in case the cluster manager provides one).
Â     listenerBus.post(SparkListenerApplicationStart(appName, Some(applicationId),
Â       startTime, sparkUser, applicationAttemptId, schedulerBackend.getDriverLogUrls,
Â       schedulerBackend.getDriverAttributes))
Â     _driverLogger.foreach(_.startSync(_hadoopConfiguration))
Â   }</span></span></span></code></pre><div id="https://www.notion.so/cb1819c274cf40ae8b985685d61f4eb2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼ŒSpark å†…éƒ¨åœ¨æäº¤ Event çš„æ—¶å€™ï¼Œå·²ç»åŒ…å«äº†å¾ˆä¸°å¯Œçš„ä¿¡æ¯ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œè¿™äº›äº‹ä»¶æœ€ç»ˆä¼šè¢«æŠ•é€’ç»™å…¶ä»– Listenerã€‚</span></span></p></div><div id="https://www.notion.so/e8cdbd1f56164440ba4238075e170350" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å› æ­¤å¦‚æœæƒ³è¦è·å–è¿™äº›æ¶ˆæ¯äº‹ä»¶ï¼Œæ–¹å¼ååˆ†ç®€å•ï¼Œåªéœ€è¦å®ç°è‡ªå·±çš„ Listener å¹¶æ³¨å†Œåˆ° SparkContext ä¸­å³å¯ã€‚</span></span></p></div><div id="https://www.notion.so/ed449b9919864af1a46a6effd586df93" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç»§ç»­ä»¥ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SparkListener</code></span><span class="SemanticString"> ä¸ºä¾‹ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ SparkContext ä¸­æ·»åŠ è‡ªå®šä¹‰ Listenerï¼Œé‡å†™éœ€è¦çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œè¿™é‡Œåªé‡å†™ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">onTaskEnd</code></span><span class="SemanticString"> æ–¹æ³•ï¼š</span></span></p></div><pre id="https://www.notion.so/83ed9d492f2c431a9f2f33bc0542605a" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   def main(args: Array[String]): Unit = {
Â     val spark = SparkSession
Â       .builder()
Â       .appName(&quot;zkx-test1&quot;)
Â       .master(&quot;local[2]&quot;)
Â       .getOrCreate()
Â     spark.sparkContext.addSparkListener(new SparkListener {
Â       override def onTaskEnd(taskEnd: SparkListenerTaskEnd): Unit = println(&quot;Task End...&quot;)
Â     })
Â     spark.sql(&quot;SELECT 1&quot;).show()
Â   }</span></span></span></code></pre><div id="https://www.notion.so/d60560a752f844c68c53f56af2824df2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ‰§è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/9ebfb0656b1248a69a69df0ea997e213" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â ...
Â 21/06/12 15:57:26 INFO DAGScheduler: Job 0 finished: show at TransportRPCTest.scala:19, took 0.823017 s
Â Task End...
Â 21/06/12 15:57:26 INFO CodeGenerator: Code generated in 21.0197 ms
Â +---+
Â |  1|
Â +---+
Â |  1|
Â +---+
Â ...</span></span></span></code></pre></article>
  <footer class="Footer">
        <div>&copy; Rianicoâ€˜s Blog 2019</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>