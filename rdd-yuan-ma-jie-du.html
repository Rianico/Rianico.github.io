<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="RDD æºç è§£è¯»">
  
  <meta name="description" content="è§£è¯» Spark 3.0.0 çš„æ¶ˆæ¯æ€»çº¿æºç ">
  <meta property="og:description" content="è§£è¯» Spark 3.0.0 çš„æ¶ˆæ¯æ€»çº¿æºç ">
  
  <meta property="og:type" content="blog">
  <title>RDD æºç è§£è¯»</title>
  <!-- Favicon -->
  
  <link rel="shortcut icon" href="https://avatars1.githubusercontent.com/u/32795735?s=400&u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&v=4">
  
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span><img class="inline-img-icon" src="https://avatars1.githubusercontent.com/u/32795735?s=400&u=40ed0595fb3044b01c47849f59ad96d69b4dc8db&v=4"></span> <span>Home</span></div>
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>ğŸ˜€</span> <span>About</span></div>
    </a>
    
    
  </nav>
  <header class="Header">
      
    <div class="Header__Cover">
        <img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc5f33405-3269-47ac-96a2-fbcb8271d259%2Fphoto-1509910110001-4e756f86fbd3.jfif?table=block&id=cfb76b2b-e6f9-4b7d-86f5-a1288683c8bc">
      </div>
      
    <div class="Header__Spacer ">
    </div>
    
    <div class="Header__Icon"><span><img class="inline-img-icon" src="https://raw.githubusercontent.com/Rianico/Image/master/Avator/sparkles%20(1).png"></span></div>
    
    <h1 class="Header__Title">RDD æºç è§£è¯»</h1>
        
    <div class="DateTagBar">
          
      <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Aug 21, 2021</span>
          
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--default">
            <a href="tag/Spark.html">Spark</a>
          </span>
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/Scala.html">Scala</a>
          </span>
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--green">
            <a href="tag/æºç .html">æºç </a>
          </span>
          
        </div>
        
  </header>
      <article id="https://www.notion.so/cfb76b2be6f94b7d86f5a1288683c8bc" class="PageRoot PageRoot--FullWidth"><ul id="https://www.notion.so/d453e87d17464e80aba4a6d4c4fe5aee" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/aa35dec4de6f407c810d5ce7801ba7fc"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1. RDD çš„å®šä¹‰</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cf80f84196d14051a054a3b5335e9062"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. æºç è§£è¯»</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/e3e8021cf92941cc924d50e3bb685fbe"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2.1 RDD çš„æ„é€ </strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/d12714cb8ecf458da9a9bdeb15d65e4a"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2.2 Transformation</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3e35e32f762c45bc9f6149184f3b964d"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2.3 Action</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3b958f94934646a88e47d0a74cfe0d39"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. æ‰©å±•</strong></span></span></div></a></li></ul><h2 id="https://www.notion.so/aa35dec4de6f407c810d5ce7801ba7fc" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/aa35dec4de6f407c810d5ce7801ba7fc"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1. RDD çš„å®šä¹‰</strong></span></span></h2><div id="https://www.notion.so/5e41db92eef4492da06c04fda66c2ce6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RDD ï¼Œæ˜¯ Spark å¯¹ä¸€ç»„æ•°æ®é›†åˆçš„æŠ½è±¡æè¿°ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªå¼¹æ€§çš„ã€å¯å®¹é”™çš„åˆ†å¸ƒå¼æ•°æ®é›†åˆã€‚RDD å¯ä»¥ä»çºµå‘ä¸æ¨ªå‘åˆ’åˆ†å‡ºå››ä¸ªå±æ€§ï¼š</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/7dee9b72edcf4d8f85e4e7bded8e40cd" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">çºµå‘ï¼šDependencyã€Compute</span></span></li><li id="https://www.notion.so/197eb302a4f544f5a44682f4a0f823b7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">æ¨ªå‘ï¼šPartitionerã€Partitions</span></span></li></ul><div id="https://www.notion.so/6834a4497d5b4de1b999e99ee324da10" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Spark åŸºäº Dependency æ„å»ºè¡€ç¼˜å…³ç³»ï¼Œå¹¶ç”Ÿæˆä¸€å¼ æœ‰å‘æ— ç¯å›¾ï¼Œæœ‰å‘æ— ç¯å›¾å¯ä»¥æ ¹æ® Shuffle åˆ’åˆ†ä¸ºå¤šä¸ª Stageï¼Œæ¯ä¸ª Stage éƒ½å¯ä»¥è½¬åŒ–å¤šä¸ª Compute ä»»åŠ¡ï¼Œå¹¶åˆ†å‘åˆ°å„ä¸ª Partition ä¸Šï¼ŒPartitioner åˆ™å†³å®šäº†æ•°æ®åº”è¯¥å»å¾€å“ªä¸ª Partitionã€‚</span></span></p></div><h2 id="https://www.notion.so/cf80f84196d14051a054a3b5335e9062" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cf80f84196d14051a054a3b5335e9062"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. æºç è§£è¯»</strong></span></span></h2><h3 id="https://www.notion.so/e3e8021cf92941cc924d50e3bb685fbe" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e3e8021cf92941cc924d50e3bb685fbe"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2.1 RDD çš„æ„é€ </strong></span></span></h3><div id="https://www.notion.so/e1ba99c895c94e52a82a2e0191ee4a05" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RDD çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/341242d126ba46ca90f228a19d33d0c1" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â abstract class RDD[T: ClassTag](
Â     @transient private var _sc: SparkContext,
Â     @transient private var deps: Seq[Dependency[_]]
Â   ) extends Serializable with Logging {
Â   // ......
Â   /** Construct an RDD with just a one-to-one dependency on one parent */
Â   def this(@transient oneParent: RDD[_]) =
Â     this(oneParent.context, List(new OneToOneDependency(oneParent)))
Â   // ......
Â   /**
Â    * :: DeveloperApi ::
Â    * Implemented by subclasses to compute a given partition.
Â    */
Â   @DeveloperApi
Â   def compute(split: Partition, context: TaskContext): Iterator[T]
Â 
Â   /**
Â    * Implemented by subclasses to return the set of partitions in this RDD. This method will only
Â    * be called once, so it is safe to implement a time-consuming computation in it.
Â    *
Â    * The partitions in this array must satisfy the following property:
Â    *   `rdd.partitions.zipWithIndex.forall { case (partition, index) =&gt; partition.index == index }`
Â    */
Â   protected def getPartitions: Array[Partition]
Â 
Â   /**
Â    * Implemented by subclasses to return how this RDD depends on parent RDDs. This method will only
Â    * be called once, so it is safe to implement a time-consuming computation in it.
Â    */
Â   protected def getDependencies: Seq[Dependency[_]] = deps
Â 
Â   /**
Â    * Optionally overridden by subclasses to specify placement preferences.
Â    */
Â   protected def getPreferredLocations(split: Partition): Seq[String] = Nil
Â 
Â   /** Optionally overridden by subclasses to specify how they are partitioned. */
Â   @transient val partitioner: Option[Partitioner] = None
Â   // ......
Â }</span></span></span></code></pre><div id="https://www.notion.so/3399e5f0f9e64bf88179b110c2db39c4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å„æ„é€ å‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/f98a47c1ad5f4fad99b6609de29c5d96" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">_sc</code></span><span class="SemanticString">ï¼š SparkContextï¼Œå­˜å‚¨äº† Spark çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span></li><li id="https://www.notion.so/9cbca5a212ae4da988bf3366fe3e7c13" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">deps</code></span><span class="SemanticString">ï¼š è¡¨ç¤º RDD ä¾èµ–é“¾ï¼ŒRDD æ­£æ˜¯ä¾èµ– Dependency åºåˆ—æ„å»ºè¡€ç¼˜ï¼Œå¹¶è¿›è¡Œå›æº¯çš„ï¼›æ•°ç»„ç±»å‹æ„å‘³ç€ä¸€ä¸ª RDD å¯èƒ½æœ‰å¤šæ¡ä¾èµ–é“¾ï¼Œå¦‚ ZippedPartitionsRDD2</span></span></li></ul><div id="https://www.notion.so/47bfe164636a42cb994ce8b7420e9f30" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åŒæ—¶è¿˜æœ‰ä¸€äº›é‡è¦çš„å†…éƒ¨å˜é‡åŠæ–¹æ³•ï¼š</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/ad92e1a78e6547b8937510c20e1813d3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">computeï¼š è®¡ç®—é€»è¾‘ï¼Œç”±å­ç±»å…·ä½“å®ç°</span></span></li><li id="https://www.notion.so/a01be82bf9c242698d39580c2d84501b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">getPartitionsï¼šè·å–åˆ†åŒºæ•°ç»„ï¼Œä»…ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼ˆå¦‚è§¦å‘ action æ—¶ï¼Œæ­¤å¤„æš‚ä¸è¯¦ç»†å±•å¼€ï¼‰</span></span></li><li id="https://www.notion.so/2f99cc16a4804649851f4071923700c9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">getDependenciesï¼š è·å–ä¾èµ–çš„çˆ¶ RDDï¼ŒåŒæ ·è¿›ä¼šè¢«è°ƒç”¨ä¸€æ¬¡</span></span></li><li id="https://www.notion.so/06432b493aed40bd866880cc65be968c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">partitionerï¼Œå®šä¹‰äº†æ•°æ® Shuffle æ—¶çš„è§„åˆ™ï¼Œéœ€è¦ç”±å­ç±»å…·ä½“å»å®ç°</span></span></li></ul><div id="https://www.notion.so/e20b08376a844876905e39ecee1d961e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼ŒRDD é‡Œçš„å˜é‡ä»¥åŠæ–¹æ³•ä¹Ÿå¯¹åº”äº† Dependencyã€Computeã€Partitionsã€Partitioner ã€‚</span></span></p></div><div id="https://www.notion.so/2d91eb56e4d14bdf8fe356939a74510d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RDD ä½¿ç”¨æ³›å‹æ¥è¡¨ç¤ºä»»æ„æ•°æ®ç±»å‹ï¼Œè¿™ä½¿å¾— RDD ååˆ†çµæ´»ï¼Œå…è®¸åœ¨å†…éƒ¨å­˜å‚¨ä»»æ„ç»“æ„çš„æ•°æ®ã€‚</span></span></p></div><div id="https://www.notion.so/5379d9e3e72247ed86c138e0310e42f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RDD æœ‰è®¸å¤šå­ç±»å®ç°ï¼Œè¿™é‡Œæš‚ä¸”ä»¥æ„é€ åˆå§‹æ•°æ®çš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.rdd.ParallelCollectionRDD</code></span><span class="SemanticString">ï¼ˆå¤æ‚ç‚¹çš„è¿˜æœ‰ HadoopRDD ç­‰ï¼‰ ä¸ºä¾‹ï¼Œæœ‰å¦‚ä¸‹ä»£ç ï¼š</span></span></p></div><pre id="https://www.notion.so/2f2ef0ad85b24dcb8559cefc643ee5cc" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â val rdd1 = spark.sparkContext.makeRDD(Seq(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;))</span></span></span></code></pre><div id="https://www.notion.so/f99782cabb804b1988a33e8341dd160d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å…¶ä¸­ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">makeRDD(...)</code></span><span class="SemanticString"> æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª ParallelCollectionRDDï¼š</span></span></p></div><pre id="https://www.notion.so/51dbe102a5414fe1a822af372a2f9f7e" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   def makeRDD[T: ClassTag](
Â       seq: Seq[T],
Â       numSlices: Int = defaultParallelism): RDD[T] = withScope {
Â     // ä¼ å…¥æ•°æ®åºåˆ—ä»¥åŠæŒ‡å®šåˆ†ç‰‡
Â     parallelize(seq, numSlices)
Â   }
Â 
Â   def parallelize[T: ClassTag](
Â       seq: Seq[T],
Â       numSlices: Int = defaultParallelism): RDD[T] = withScope {
Â     assertNotStopped()
Â     // åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª ParallelCollectionRDD
Â     new ParallelCollectionRDD[T](this, seq, numSlices, Map[Int, Seq[String]]())
Â   }</span></span></span></code></pre><div id="https://www.notion.so/f73ce771a364406193e306e20d6175d4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å…¶ä¸­ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">withScope</code></span><span class="SemanticString"> ä¸»è¦é€‚ç”¨äºè®°å½•ä¸€äº› RDD æ„é€ è¿‡ç¨‹ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚è°ƒç”¨çš„æ–¹æ³•åï¼ŒçŠ¶æ€å˜åŒ–ç­‰ï¼‰ï¼Œè¿™é‡Œå¹¶éé‡ç‚¹ï¼Œä¸åšè¯¦ç»†èµ˜è¿°ã€‚</span></span></p></div><div id="https://www.notion.so/4bb7a618f64649aab070b8ced95fa491" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æŸ¥çœ‹ ParallelCollectionRDD çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/a883af64157e49a29eac47bdc4bb0b50" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â private[spark] class ParallelCollectionRDD[T: ClassTag](
Â     sc: SparkContext,
Â     @transient private val data: Seq[T],
Â     numSlices: Int,
Â     locationPrefs: Map[Int, Seq[String]])
Â     extends RDD[T](sc, Nil) {

Â   // å­˜å‚¨äº† partition ä¿¡æ¯ï¼Œæ¯ä¸ª partition ä»£è¡¨ä¸€ä¸ªåˆ†ç‰‡çš„æ•°æ®
Â   override def getPartitions: Array[Partition] = {
Â     val slices = ParallelCollectionRDD.slice(data, numSlices).toArray
Â     slices.indices.map(i =&gt; new ParallelCollectionPartition(id, i, slices(i))).toArray
Â   }
Â 
Â   // å…·ä½“è®¡ç®—é€»è¾‘ï¼Œå¯ä»¥æ¥æ”¶ä¸€ä¸ªå…·ä½“çš„ parition å¹¶å°è£…ä¸ºä¸€ä¸ª Iterator
Â   override def compute(s: Partition, context: TaskContext): Iterator[T] = {
Â     new InterruptibleIterator(context, s.asInstanceOf[ParallelCollectionPartition[T]].iterator)
Â   }
Â 
Â   // å­˜å‚¨äº†æ•°æ®æœ¬åœ°æ€§çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸åŒ RDD æœ‰ä¸åŒçš„å®ç°ï¼ŒHadoopRDD åˆ™æ˜¯å­˜å‚¨åœ¨ split ä¸­
Â   override def getPreferredLocations(s: Partition): Seq[String] = {
Â     locationPrefs.getOrElse(s.index, Nil)
Â   }
Â }</span></span></span></code></pre><div id="https://www.notion.so/86ff0b4720c34b9aa2cde5a3943730a4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼ŒParallelCollectionRDD ä¼šå°†æ¥æ”¶åˆ°çš„ SparkContext ä¼ é€’ç»™ RDD æ¥å£ï¼ŒåŒæ—¶å°†ä¸€ä¸ª </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Nil</code></span><span class="SemanticString"> å¯¹è±¡ä¼ é€’ç»™ RDD æ¥å£è®°å½•åˆ° </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">deps</code></span><span class="SemanticString"> ä¸­ï¼Œè¿™æ˜¯ç”±äºå½“å‰ RDD å±äºæœ€èµ·å§‹çš„ RDDï¼Œå¹¶æ²¡æœ‰ä¾èµ–çš„çˆ¶ RDDã€‚è‡³æ­¤ï¼Œä¸€ä¸ª ParallelCollectionRDD çš„æ„é€ ä¾¿ç»“æŸäº†ã€‚</span></span></p></div><h3 id="https://www.notion.so/d12714cb8ecf458da9a9bdeb15d65e4a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d12714cb8ecf458da9a9bdeb15d65e4a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2.2 Transformation</strong></span></span></h3><div id="https://www.notion.so/094c290b4ab74b53a2d5d0ea82a9ee33" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Transformation ç®—å­ï¼Œå¯ä»¥ä»ä¸€ä¸ª RDD ç”Ÿæˆå¦ä¸€ä¸ª RDDï¼Œæ„é€ è®¡ç®—é€»è¾‘ï¼Œä½†ä¸è§¦å‘çœŸæ­£çš„è®¡ç®—ã€‚</span></span></p></div><div id="https://www.notion.so/ff3fe780873c4c5ea5995bc1633b3769" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯¹å‰é¢å®šä¹‰çš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rdd1</code></span><span class="SemanticString"> æ‰§è¡Œ Transformation æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/e79cf5c2c55040f09869e3c274743123" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â val rdd2 = rdd1.flatMap(line =&gt; line.split(&quot;\n&quot;))
Â     .map((_, 1))</span></span></span></code></pre><div id="https://www.notion.so/4124a1951f624fceb04b080c12bd05d5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä»¥ä¸‹åˆ†åˆ«ä¸º </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">flatMap</code></span><span class="SemanticString"> ä»¥åŠ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">map</code></span><span class="SemanticString"> æ–¹æ³•çš„æºç ï¼š</span></span></p></div><pre id="https://www.notion.so/f0a1bfe393c64652acf98f92c352696a" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   def flatMap[U: ClassTag](f: T =&gt; TraversableOnce[U]): RDD[U] = withScope {
Â     val cleanF = sc.clean(f)
Â     new MapPartitionsRDD[U, T](this, (_, _, iter) =&gt; iter.flatMap(cleanF))
Â   }

Â   def map[U: ClassTag](f: T =&gt; U): RDD[U] = withScope {
Â     val cleanF = sc.clean(f)
Â     new MapPartitionsRDD[U, T](this, (_, _, iter) =&gt; iter.map(cleanF))
Â   }</span></span></span></code></pre><div id="https://www.notion.so/6c209381738c465cbfbf77cf3ba7f640" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯æ„é€ ä¸€ä¸ª </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.rdd.MapPartitionsRDD</code></span><span class="SemanticString">ï¼ŒRDD è°ƒç”¨è¿™äº›é«˜é˜¶å‡½æ•°ï¼Œå¹¶å°†è‡ªèº« </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">this</code></span><span class="SemanticString"> ä»¥åŠæ¥æ”¶åˆ°çš„æ–¹æ³• </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f</code></span><span class="SemanticString"> ä½œä¸º MapPartitionsRDD æ„é€ å‚æ•°ã€‚</span></span></p></div><div id="https://www.notion.so/4119097514774216b31fa972d9437c5b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">MapPartitionsRDD çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/6bd63d19db6b438dac41b066c56ca9ec" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â private[spark] class MapPartitionsRDD[U: ClassTag, T: ClassTag](
Â     var prev: RDD[T],
Â     f: (TaskContext, Int, Iterator[T]) =&gt; Iterator[U],  // (TaskContext, partition index, iterator)
Â     preservesPartitioning: Boolean = false,
Â     isFromBarrier: Boolean = false,
Â     isOrderSensitive: Boolean = false)
Â   extends RDD[U](prev) {
Â 
Â   override val partitioner = if (preservesPartitioning) firstParent[T].partitioner else None
Â 
Â   override def getPartitions: Array[Partition] = firstParent[T].partitions
Â 
Â   override def compute(split: Partition, context: TaskContext): Iterator[U] =
Â     f(context, split.index, firstParent[T].iterator(split, context))
Â   // ......
Â }</span></span></span></code></pre><div id="https://www.notion.so/3e4cab64e7d84e44941f4a0457495d5c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼ŒRDD å°†è‡ªèº«ä¼ å…¥ MapPartitionsRDD åï¼ŒMapPartitionsRDD åˆé€šè¿‡ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">RDD[U](prev)</code></span><span class="SemanticString"> å°†å…¶ä¼ é€’ç»™ RDD æ¥å£ï¼Œç”±å‰é¢å¯¹ RDD æºç çš„è§£æå¯çŸ¥ï¼Œè¿™ä¸ª </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">poev</code></span><span class="SemanticString"> ä¼šè¢«æ„é€ ä¸ºä¸€ä¸ª Dependency è®°å½•èµ·æ¥ï¼š</span></span></p></div><pre id="https://www.notion.so/0d71769d2aa04499a72c2d69965f177d" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   def this(@transient oneParent: RDD[_]) =
Â     this(oneParent.context, List(new OneToOneDependency(oneParent)))</span></span></span></code></pre><div id="https://www.notion.so/03073ac131e34c9c86d14e0bf3c69c2f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è‡³æ­¤ï¼ŒRDD ä¹‹é—´çš„ Dependency æ„é€ å¤§è‡´æ˜¯ç†æ¸…äº†ï¼šä¸€ä¸ª RDD ç”Ÿæˆæ–°çš„ RDDï¼Œæ–°çš„ RDD ä¼šå°†æŠŠçˆ¶ RDD æ„é€ ä¸º Dependency ä¿å­˜èµ·æ¥ã€‚</span></span></p></div><h3 id="https://www.notion.so/3e35e32f762c45bc9f6149184f3b964d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/3e35e32f762c45bc9f6149184f3b964d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2.3 Action</strong></span></span></h3><div id="https://www.notion.so/56211d8f7011464dac134d68b7a9204f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Action ä¼šçœŸæ­£è§¦å‘ RDD çš„è®¡ç®—é€»è¾‘ï¼Œæ‰§è¡Œå‰é¢æŒ‡å®šçš„ Transformation   ç®—å­ã€‚</span></span></p></div><div id="https://www.notion.so/ccb641ead5f041bc9517b165dbd4bc3d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯¹ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rdd2</code></span><span class="SemanticString"> æ‰§è¡Œ Action ç®—å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/f469c8a016a646f78098dcebbe92a0f9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â rdd2.foreach(println)</span></span></span></code></pre><div id="https://www.notion.so/bad157b7eb0849358c6f27ce20189fb4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æŸ¥çœ‹ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">foreach</code></span><span class="SemanticString"> ä»£ç ï¼š</span></span></p></div><pre id="https://www.notion.so/af7c55e691df430a96286b77e3d8b6c9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   def foreach(f: T =&gt; Unit): Unit = withScope {
Â     val cleanF = sc.clean(f)
Â     sc.runJob(this, (iter: Iterator[T]) =&gt; iter.foreach(cleanF))
Â   }
Â 
Â   def runJob[T, U: ClassTag](rdd: RDD[T], func: Iterator[T] =&gt; U): Array[U] = {
Â     runJob(rdd, func, 0 until rdd.partitions.length)
Â   }</span></span></span></code></pre><div id="https://www.notion.so/afb47ba76e5f453ca50e2d6d7737bf45" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼ŒRDD é€šè¿‡ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">foreach</code></span><span class="SemanticString"> è°ƒç”¨ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sc.runJob()</code></span><span class="SemanticString"> æ–¹æ³•ï¼Œå°†è‡ªèº«ä¼ ä»¥åŠä¸€ä¸ªå‡½æ•°ä¼ é€’è¿›å»ï¼Œå¹¶ä¸”è¿˜ä¼šé€šè¿‡ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rdd.partitions</code></span><span class="SemanticString"> è®¿é—® RDD çš„ partition ä¿¡æ¯ã€‚</span></span></p></div><div id="https://www.notion.so/ba54167bcd4942f688ec5b676a717af6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ä»è¿™é‡Œï¼Œä¼šå¼€å§‹å€ŸåŠ©å‰é¢æ„é€ çš„ Dependency ä¿¡æ¯ï¼Œä¸€å±‚ä¸€å±‚çš„è¿½æº¯çˆ¶ RDD çš„ partition ä¿¡æ¯ï¼Œå…¶å®ç°å¦‚ä¸‹</strong></span><span class="SemanticString">ï¼š</span></span></p></div><pre id="https://www.notion.so/8dc9c02f881d4939b1e538e1213fc277" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   // rdd.partitions
Â   final def partitions: Array[Partition] = {
Â     checkpointRDD.map(_.partitions).getOrElse {
Â       if (partitions_ == null) {
Â         stateLock.synchronized {
Â           if (partitions_ == null) {
Â             // è°ƒç”¨ RDD çš„ getPartitions
Â             partitions_ = getPartitions
Â             partitions_.zipWithIndex.foreach { case (partition, index) =&gt;
Â               require(partition.index == index,
Â                 s&quot;partitions($index).partition == ${partition.index}, but it should equal $index&quot;)
Â             }
Â           }
Â         }
Â       }
Â       partitions_
Â     }
Â   }</span></span></span></code></pre><div id="https://www.notion.so/f26fb3ac0e7642fcbc4b85abfb927f00" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ­¤å¤„çš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rdd.partitions</code></span><span class="SemanticString"> å†…éƒ¨ä¼šè°ƒç”¨å…¶ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">getPartitions</code></span><span class="SemanticString"> æ–¹æ³•ï¼Œæ ¹æ®ä¹‹å‰çš„æºç è§£æï¼Œå¯ä»¥çŸ¥é“è¿™æ˜¯ RDD çš„ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåœ¨ MapPartitionsRDD ä¸­çš„å®ç°åŠè°ƒç”¨å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/46e270c310204ac58e786832eaaba4a9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   // org.apache.spark.rdd.MapPartitionsRDD#getPartitions
Â   override def getPartitions: Array[Partition] = firstParent[T].partitions
Â 
Â   // org.apache.spark.rdd.RDD#firstParent
Â   protected[spark] def firstParent[U: ClassTag]: RDD[U] = {
Â     dependencies.head.rdd.asInstanceOf[RDD[U]]
Â   }

Â   // org.apache.spark.rdd.RDD#dependencies
Â   final def dependencies: Seq[Dependency[_]] = {
Â     checkpointRDD.map(r =&gt; List(new OneToOneDependency(r))).getOrElse {
Â       if (dependencies_ == null) {
Â         stateLock.synchronized {
Â           if (dependencies_ == null) {
Â             // è·å– denpendency åºåˆ—
Â             dependencies_ = getDependencies
Â           }
Â         }
Â       }
Â       dependencies_
Â     }
Â   }
Â 
Â   // org.apache.spark.rdd.RDD#getDependencies
Â   protected def getDependencies: Seq[Dependency[_]] = deps</span></span></span></code></pre><div id="https://www.notion.so/0a12257523b44cfeaba4c633551b8112" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼ŒMapPartitionsRDD é€šè¿‡è°ƒç”¨é“¾  </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.rdd.RDD#firstParent</code></span><span class="SemanticString">  -&gt; </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.rdd.RDD#dependencies</code></span><span class="SemanticString"> -&gt; </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.rdd.RDD#getDependencies</code></span><span class="SemanticString">ï¼Œä» Dependency è·å–åˆ°çˆ¶ RDDï¼Œæ¥ç€çˆ¶ RDD ä¹Ÿä¼šè°ƒç”¨ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">partitions</code></span><span class="SemanticString"> æ–¹æ³•ï¼Œå†æ¬¡é‡å¤ä¸Šè¿°æ­¥éª¤ç›´åˆ°ï¼ˆå½“å‰ Stageï¼‰æœ€é¡¶çº§çš„ RDDã€‚</span></span></p></div><div id="https://www.notion.so/876a10e18fd14e3e823f1573b8ba6f13" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æŒ‰ç…§ä¾‹å­ä¸­ RDD çš„æ„å»ºé¡ºåºï¼Œæœ€ç»ˆä¼šè¿½æº¯åˆ° </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ParallelCollectionRDD</code></span><span class="SemanticString">ï¼Œå…¶ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">getPartitions</code></span><span class="SemanticString"> å®ç°å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/6e62c2a99443438a88d804f3090ae3db" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   override def getPartitions: Array[Partition] = {
Â     val slices = ParallelCollectionRDD.slice(data, numSlices).toArray
Â     slices.indices.map(i =&gt; new ParallelCollectionPartition(id, i, slices(i))).toArray
Â   }</span></span></span></code></pre><div id="https://www.notion.so/7d5031d237734aaa86cfc3cd501e4b55" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ„é€ äº† ParallelCollectionRDD çš„ Parititon æ•°ç»„ï¼Œpartition åœ¨æœ€åˆæ„é€ çš„æ—¶å€™å°±å·²ç»å†³å®šäº†ï¼Œä¹‹åé€çº§å›åˆ°ä¹‹å‰çš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.SparkContext#runJob</code></span><span class="SemanticString"> æ–¹æ³•ä¸­ï¼Œç»§ç»­å¾€ä¸‹èµ°ï¼š</span></span></p></div><pre id="https://www.notion.so/6b8ed7cbd4bc4dc1a79c0731abd28319" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   def runJob[T, U: ClassTag](rdd: RDD[T], func: Iterator[T] =&gt; U): Array[U] = {
Â     runJob(rdd, func, 0 until rdd.partitions.length)
Â   }

Â   def runJob[T, U: ClassTag](
Â       rdd: RDD[T],
Â       func: Iterator[T] =&gt; U,
Â       partitions: Seq[Int]): Array[U] = {
Â     val cleanedFunc = clean(func)
Â     runJob(rdd, (ctx: TaskContext, it: Iterator[T]) =&gt; cleanedFunc(it), partitions)
Â   }

Â   def runJob[T, U: ClassTag](
Â       rdd: RDD[T],
Â       func: (TaskContext, Iterator[T]) =&gt; U,
Â       partitions: Seq[Int]): Array[U] = {
Â     val results = new Array[U](partitions.size)
Â     runJob[T, U](rdd, func, partitions, (index, res) =&gt; results(index) = res)
Â     results
Â   }
Â 
Â   def runJob[T, U: ClassTag](
Â       rdd: RDD[T],
Â       func: (TaskContext, Iterator[T]) =&gt; U,
Â       partitions: Seq[Int],
Â       resultHandler: (Int, U) =&gt; Unit): Unit = {
Â     if (stopped.get()) {
Â       throw new IllegalStateException(&quot;SparkContext has been shutdown&quot;)
Â     }
Â     val callSite = getCallSite
Â     val cleanedFunc = clean(func)
Â     logInfo(&quot;Starting job: &quot; + callSite.shortForm)
Â     if (conf.getBoolean(&quot;spark.logLineage&quot;, false)) {
Â       logInfo(&quot;RDD&#x27;s recursive dependencies:\n&quot; + rdd.toDebugString)
Â     }
Â     // DAGScheduler è´Ÿè´£æ„é€  taskset å¹¶ç»“åˆ taskSchedulerã€SchedulerBackend åˆ†å‘ä»»åŠ¡
Â     dagScheduler.runJob(rdd, cleanedFunc, partitions, callSite, resultHandler, localProperties.get)
Â     progressBar.foreach(_.finishAll())
Â     rdd.doCheckpoint()
Â   }</span></span></span></code></pre><div id="https://www.notion.so/a6fd62c1e23949fabbb5c4f90cdae9ba" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç»è¿‡å¤šä¸ªå‡½æ•°è°ƒç”¨åï¼Œä¼šèµ°åˆ° DAGScheduler é‚£é‡ŒçœŸæ­£çš„æäº¤ä»»åŠ¡ã€‚è°ƒåº¦æ¨¡å—çš„æºç ä¸å±äºæ­¤æ¬¡è§£è¯»èŒƒå›´ï¼Œæš‚ä¸è¯¦ç»†å±•å¼€ï¼Œè¿™éƒ¨åˆ†ä¸»è¦å·¥ä½œæ˜¯æ„é€  task çš„ç›¸å…³ä¿¡æ¯ï¼Œæœ€ç»ˆå°† task ä»¥ RPC çš„æ–¹å¼æ¨é€åˆ°å„ä¸ª Executor ç«¯ã€‚</span></span></p></div><div id="https://www.notion.so/9992ae750c934c1f837579402d175910" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä¸ RDD è·å– partitions ä¿¡æ¯ä¸€æ ·ï¼ŒRDD çš„ Compute åŒæ ·æ˜¯å€ŸåŠ© Dependency åµŒå¥—æ‰§è¡Œï¼ˆVolcano æ¨¡å‹ï¼‰ çš„ã€‚Executor  åœ¨æ¥æ”¶åˆ°è°ƒåº¦å™¨å‘æ¥çš„ task æ—¶ï¼Œä¼šå¯¹å…¶è¿›è¡Œå¤„ç†å¹¶å°è£…ä¸º Runnable æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œï¼š</span></span></p></div><pre id="https://www.notion.so/a16739ea9155424fa1d5ec057c1ce8f6" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â // org.apache.spark.scheduler.cluster.CoarseGrainedClusterMessages.LaunchTask$#unapply
Â case LaunchTask(data) =&gt;
Â     if (executor == null) {
Â         exitExecutor(1, &quot;Received LaunchTask command but executor was null&quot;)
Â     } else {
Â         // ååºåˆ—åŒ– task
Â         val taskDesc = TaskDescription.decode(data.value)
Â         logInfo(&quot;Got assigned task &quot; + taskDesc.taskId)
Â         taskResources(taskDesc.taskId) = taskDesc.resources
Â         // å¯åŠ¨ä¸€ä¸ª task
Â         executor.launchTask(this, taskDesc)
Â     }
Â 
Â 
Â def launchTask(context: ExecutorBackend, taskDescription: TaskDescription): Unit = {
Â     // å°† task å°è£…ä¸ºå®ç°äº† Runnable æ¥å£çš„ TaskRunner
Â     val tr = new TaskRunner(context, taskDescription)
Â     runningTasks.put(taskDescription.taskId, tr)
Â     // æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œ
Â     threadPool.execute(tr)
Â }</span></span></span></code></pre><div id="https://www.notion.so/57c9bd6de2d24382b548fa6e1c0a4b6c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.executor.Executor.TaskRunner</code></span><span class="SemanticString"> çš„ run æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/d915b3eab10944f3bed3140bd61f990a" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â     override def run(): Unit = {
Â     // ......
Â         val res = task.run(
Â             taskAttemptId = taskId,
Â             attemptNumber = taskDescription.attemptNumber,
Â             metricsSystem = env.metricsSystem,
Â             resources = taskDescription.resources)
Â     // ......
Â     }</span></span></span></code></pre><div id="https://www.notion.so/20cec08d70244d65b5316cca771249f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æœ€ç»ˆè°ƒç”¨ä¼šèµ°åˆ° </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.scheduler.ResultTask#runTask</code></span><span class="SemanticString"> é‡Œï¼š</span></span></p></div><pre id="https://www.notion.so/f0726ead2e5d4f4eba7eb81b092d9ef1" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   override def runTask(context: TaskContext): U = {
Â     // Deserialize the RDD and the func using the broadcast variables.
Â     val threadMXBean = ManagementFactory.getThreadMXBean
Â     val deserializeStartTimeNs = System.nanoTime()
Â     val deserializeStartCpuTime = if (threadMXBean.isCurrentThreadCpuTimeSupported) {
Â       threadMXBean.getCurrentThreadCpuTime
Â     } else 0L
Â     val ser = SparkEnv.get.closureSerializer.newInstance()
Â     val (rdd, func) = ser.deserialize[(RDD[T], (TaskContext, Iterator[T]) =&gt; U)](
Â       ByteBuffer.wrap(taskBinary.value), Thread.currentThread.getContextClassLoader)
Â     _executorDeserializeTimeNs = System.nanoTime() - deserializeStartTimeNs
Â     _executorDeserializeCpuTime = if (threadMXBean.isCurrentThreadCpuTimeSupported) {
Â       threadMXBean.getCurrentThreadCpuTime - deserializeStartCpuTime
Â     } else 0L
Â 
Â     func(context, rdd.iterator(partition, context))
Â   }</span></span></span></code></pre><div id="https://www.notion.so/e089bbeedfaf4c0bbd457d77adc9f469" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ³•æœ€åä¸€è¡Œ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rdd.iterator</code></span><span class="SemanticString"> åˆä¼šè§¦å‘çˆ¶ RDD çš„æº¯æºï¼š</span></span></p></div><pre id="https://www.notion.so/e8a987eae6c340aca6ba8c448856f007" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â   // org.apache.spark.rdd.RDD#iterator
Â   final def iterator(split: Partition, context: TaskContext): Iterator[T] = {
Â     if (storageLevel != StorageLevel.NONE) {
Â       getOrCompute(split, context)
Â     } else {
Â       // å¹¶æœªè¿›è¡ŒæŒä¹…åŒ–ï¼Œèµ°ä¸‹é¢çš„é€»è¾‘
Â       computeOrReadCheckpoint(split, context)
Â     }
Â   }
Â 
Â   // org.apache.spark.rdd.RDD#computeOrReadCheckpoint
Â   private[spark] def computeOrReadCheckpoint(split: Partition, context: TaskContext): Iterator[T] =
Â   {
Â     if (isCheckpointedAndMaterialized) {
Â       firstParent[T].iterator(split, context)
Â     } else {
Â       // è°ƒç”¨ RDD çš„ compute æ–¹æ³•
Â       compute(split, context)
Â     }
Â   }
Â 
Â private[spark] class MapPartitionsRDD[U: ClassTag, T: ClassTag](
Â     var prev: RDD[T],
Â     f: (TaskContext, Int, Iterator[T]) =&gt; Iterator[U],  // (TaskContext, partition index, iterator)
Â     preservesPartitioning: Boolean = false,
Â     isFromBarrier: Boolean = false,
Â     isOrderSensitive: Boolean = false)
Â   extends RDD[U](prev) {
Â   // ......
Â   override def compute(split: Partition, context: TaskContext): Iterator[U] =
Â     f(context, split.index, firstParent[T].iterator(split, context))
Â   // ......
Â }</span></span></span></code></pre><div id="https://www.notion.so/3ae2702458824cd68c4a34a13bcb2919" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°æœ€ç»ˆåˆå›åˆ°å„ä¸ª RDD è‡ªè¡Œå®ç°çš„ copmute å‡½æ•°å¹¶é€šè¿‡ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">firstParent</code></span><span class="SemanticString"> è¿½æº¯çˆ¶ RDD ç›´åˆ°ï¼ˆå½“å‰ Stageï¼‰æœ€é¡¶çº§çš„ RDDã€‚</span></span></p></div><div id="https://www.notion.so/1cbc6e53899e442c994d434b225bc0c2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥çœ‹åˆ°ï¼Œ</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">compute</code></span><span class="SemanticString"> æ–¹æ³•æ˜¯å°†ä¸€ä¸ªæ–¹æ³•ä½œç”¨åœ¨ä¸€ä¸ª Iterator ä¸Šï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Iteratorï¼Œå±‚å±‚åµŒå¥—è°ƒç”¨æ‰§è¡Œè®¡ç®—çš„ã€‚</span></span></p></div><div id="https://www.notion.so/440670fc86944c3d944f663acf7faf97" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨ Iterator ä¸ŠåµŒå¥—è®¡ç®—å®Œæˆåï¼ŒExecutor è¿”å›ç»“æœä¿¡æ¯ç»™ Driverã€‚è‡³æ­¤ï¼ŒRDD çš„æ•´ä¸ªè®¡ç®—æµç¨‹ç»“æŸã€‚</span></span></p></div><h2 id="https://www.notion.so/3b958f94934646a88e47d0a74cfe0d39" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/3b958f94934646a88e47d0a74cfe0d39"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. æ‰©å±•</strong></span></span></h2><div id="https://www.notion.so/1f95b2d5840a4776b31ae0c2e9ae92ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">org.apache.spark.SparkContext#hadoopFile</code></span><span class="SemanticString"> çœ‹åˆ°è¿™æ ·ä¸€è¡Œæ³¨é‡Šï¼š</span></span></p></div><pre id="https://www.notion.so/9cf03b34281842ddbd9aff4fd2ba2566" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â // This is a hack to enforce loading hdfs-site.xml.
Â // See SPARK-11227 for details.
Â FileSystem.getLocal(hadoopConfiguration)</span></span></span></code></pre><div id="https://www.notion.so/22cace0b1b18440a85c6feb4e1e8b2a2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¤§æ„æ˜¯ä¼šå¼ºåˆ¶åŠ è½½ hdfs-site.xml é…ç½®æ–‡ä»¶çš„ä¸€ä¸ªæ“ä½œã€‚ä½†ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åšï¼Ÿ</span></span></p></div><div id="https://www.notion.so/a508f33cf12540209ffb9c166eb0a892" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Congiguration åœ¨æ–°å»ºæ—¶ï¼Œé»˜è®¤ä¼šä»åŠ è½½æœ¬åœ°é…ç½®æ–‡ä»¶ã€‚åœ¨ Spark ä¸­ï¼ŒCongiguration å®ä¾‹åŒ–å®Œæˆåéœ€è¦ç»è¿‡åºåˆ—åŒ–-ååºåˆ—ä¼ è¾“åˆ°å„ä¸ª Executor ä¸Šï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ¯ä¸ª Executor ååºåˆ—åŒ–æ–°å»º Configuration æ—¶åˆéœ€è¦ä»ç£ç›˜åŠ è½½ä¸€æ¬¡é…ç½®æ–‡ä»¶ã€‚</span></span></p></div><div id="https://www.notion.so/72ad3b9df28942468f9e5961340438f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä¸ºäº†èŠ‚çœè¿™ä¸ªå¼€é”€ï¼ˆè¯¦è§ </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://issues.apache.org/jira/browse/SPARK-8135">SPARK-8135</a></span><span class="SemanticString">)ï¼ŒSpark 1.5 ä¿®æ”¹äº† SerializableWritable ï¼ˆå®é™…ä½¿ç”¨çš„æ˜¯ SerializableConfigurationï¼Œä½†é€»è¾‘åŸºæœ¬ä¸€æ ·ï¼‰çš„ååºåˆ—åŒ–ä»£ç ï¼Œåœ¨ååºåˆ—åŒ–ç”Ÿæˆ Configuration æ—¶ä¸ä¼šå†é‡æ–°åŠ è½½æœ¬åœ°é…ç½®æ–‡ä»¶ï¼š</span></span></p></div><pre id="https://www.notion.so/da857ca2bc644113b1c6226fdf81e368" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Â class SerializableWritable[T &lt;: Writable](@transient var t: T) extends Serializable {
Â 
Â   def value: T = t
Â 
Â   override def toString: String = t.toString
Â 
Â   private def writeObject(out: ObjectOutputStream): Unit = Utils.tryOrIOException {
Â     out.defaultWriteObject()
Â     new ObjectWritable(t).write(out)
Â   }
Â 
Â   private def readObject(in: ObjectInputStream): Unit = Utils.tryOrIOException {
Â     in.defaultReadObject()
Â     val ow = new ObjectWritable()
Â     // è®¾ç½® false ä¸å†ä»ç£ç›˜ä¸Šè¯»å–é…ç½®æ–‡ä»¶
Â     ow.setConf(new Configuration(false))
Â     ow.readFields(in)
Â     t = ow.get().asInstanceOf[T]
Â   }
Â }</span></span></span></code></pre><div id="https://www.notion.so/b68b00db024b49babddcdd412677e72b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä½†è¿™æ ·å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœåœ¨ä¼ è¾“åˆ° Executor ä¹‹å‰ï¼ŒConfiguration æ²¡æœ‰å…ˆæ·»åŠ å¥½å®Œæ•´ä¿¡æ¯çš„è¯ï¼Œä¼šå¯¼è‡´ Executor ç«¯çš„ Configuration å¹¶ä¸å®Œæ•´å¯¼è‡´å¼‚å¸¸çš„å‘ç”Ÿã€‚</span></span></p></div><div id="https://www.notion.so/20508a767d2e4d96ab95caa37d57fdf3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å› æ­¤æ­¤å¤„æ‰§è¡Œäº† </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">FileSystem.getLocal(hadoopConfiguration)</code></span><span class="SemanticString"> ï¼Œå…ˆåœ¨ Driver ç«¯å¼ºåˆ¶è¯»å–æœ¬åœ°é…ç½®æ–‡ä»¶æ„é€ å®Œæ•´çš„ Configurationï¼Œå†é€šè¿‡å¹¿æ’­å˜é‡å‘é€åˆ° Executor ç«¯ã€‚æ‰§è¡Œå‰å Configuration å†…å®¹å˜åŒ–å¦‚ä¸‹ï¼š</span></span></p></div><div id="https://www.notion.so/e56a8676d6274cc19f671c3b37f498ac" class="Image Image--PageWidth"><figure><a href="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/image-20210817221214342.png"><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/image-20210817221214342.png" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/71317042135e42f3bf80a28133acd7e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¯¦ç»†çš„å®˜æ–¹ issue è¯¦è§ï¼š</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/apache/spark/pull/13738">[SPARK-11227][CORE] UnknownHostException can be thrown when NameNode HA is enabled. </a></span><span class="SemanticString">ã€‚</span></span></p></div></article>
  <footer class="Footer">
        <div>&copy; Rianicoâ€˜s Blog 2019</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>